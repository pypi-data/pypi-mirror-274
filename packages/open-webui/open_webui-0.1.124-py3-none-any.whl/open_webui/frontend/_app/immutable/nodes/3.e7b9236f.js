import{s as et,p as H,a as Oe,f as Se,M as tt,d as oe,c as Ae,g as Me,h as Ie,j as ue,i as Ne,r as ke,u as ot,Y as F,w as Z,P as st,o as nt,t as D}from"../chunks/scheduler.7238b518.js";import{S as lt,i as at,f as V,b as Re,d as Ue,m as Te,a as Be,t as Le,e as qe}from"../chunks/index.4c8b96e2.js";import{g as rt}from"../chunks/globals.7f7f1b26.js";import{a as R}from"../chunks/Toaster.svelte_svelte_type_style_lang.93775e0f.js";import"../chunks/singletons.b400c586.js";import{p as it}from"../chunks/stores.2e15bc6d.js";import{g as Ce,d as je,e as he,a as We,L as Fe,O as Ve,l as ct,m as ut,c as pt,j as ft,W as dt,h as mt}from"../chunks/index.bf1cda65.js";import{v as Ge,s as gt,a as Ye,n as ht,o as _t}from"../chunks/index.2773335b.js";import{h as wt,c as ze}from"../chunks/index.295018b5.js";import{c as bt,b as _e,u as De}from"../chunks/index.8cf31506.js";import{N as yt,M as St,c as Mt}from"../chunks/index.b80ad461.js";import{M as It}from"../chunks/Messages.c2dd6758.js";import"../chunks/create.92fd517e.js";/* empty css                                                       */const{document:He}=rt;function kt(s){var de;let se,o,_,t,b,U,G,y,S,Y,M,le,T,I,C,B,x,f,z,A,ae,J,j,E,L;He.title=se=`
		`+(s[9]?`${s[9].length>30?`${s[9].slice(0,30)}...`:s[9]} | ${s[15]}`:`${s[15]}`)+`
	`;function i(n){s[25](n)}function a(n){s[26](n)}let re={title:s[9],shareEnabled:s[12].length>0,chat:s[8],initNewChat:s[18]};s[0]!==void 0&&(re.selectedModels=s[0]),s[4]!==void 0&&(re.showModelSelector=s[4]),t=new yt({props:re}),H.push(()=>V(t,"selectedModels",i)),H.push(()=>V(t,"showModelSelector",a));function K(n){s[27](n)}function we(n){s[28](n)}function pe(n){s[29](n)}function be(n){s[30](n)}let $={chatId:s[13],selectedModels:s[0],selectedModelfiles:s[7],processing:Ct,bottomPadding:s[11].length>0,suggestionPrompts:((de=s[6])==null?void 0:de.suggestionPrompts)??s[14].default_prompt_suggestions,sendPrompt:s[20],continueGeneration:s[23],regenerateResponse:s[22]};s[1]!==void 0&&($.history=s[1]),s[12]!==void 0&&($.messages=s[12]),s[2]!==void 0&&($.autoScroll=s[2]),s[10]!==void 0&&($.prompt=s[10]),M=new It({props:$}),H.push(()=>V(M,"history",K)),H.push(()=>V(M,"messages",we)),H.push(()=>V(M,"autoScroll",pe)),H.push(()=>V(M,"prompt",be));function fe(n){s[33](n)}function Ee(n){s[34](n)}function Pe(n){s[35](n)}function ve(n){s[36](n)}let ee={messages:s[12],submitPrompt:s[19],stopResponse:s[21]};return s[11]!==void 0&&(ee.files=s[11]),s[10]!==void 0&&(ee.prompt=s[10]),s[2]!==void 0&&(ee.autoScroll=s[2]),s[5]!==void 0&&(ee.selectedModel=s[5]),f=new St({props:ee}),H.push(()=>V(f,"files",fe)),H.push(()=>V(f,"prompt",Ee)),H.push(()=>V(f,"autoScroll",Pe)),H.push(()=>V(f,"selectedModel",ve)),{c(){o=Oe(),_=Se("div"),Re(t.$$.fragment),G=Oe(),y=Se("div"),S=Se("div"),Y=Se("div"),Re(M.$$.fragment),x=Oe(),Re(f.$$.fragment),this.h()},l(n){tt("svelte-1123lr8",He.head).forEach(oe),o=Ae(n),_=Me(n,"DIV",{class:!0});var P=Ie(_);Ue(t.$$.fragment,P),G=Ae(P),y=Me(P,"DIV",{class:!0});var k=Ie(y);S=Me(k,"DIV",{class:!0,id:!0});var q=Ie(S);Y=Me(q,"DIV",{class:!0});var ne=Ie(Y);Ue(M.$$.fragment,ne),ne.forEach(oe),q.forEach(oe),k.forEach(oe),P.forEach(oe),x=Ae(n),Ue(f.$$.fragment,n),this.h()},h(){ue(Y,"class","h-full w-full flex flex-col pt-2 pb-4"),ue(S,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0 max-w-full"),ue(S,"id","messages-container"),ue(y,"class","flex flex-col flex-auto"),ue(_,"class",B="min-h-screen max-h-screen "+(s[16]?"lg:max-w-[calc(100%-260px)]":"")+" w-full max-w-full flex flex-col")},m(n,g){Ne(n,o,g),Ne(n,_,g),Te(t,_,null),ke(_,G),ke(_,y),ke(y,S),ke(S,Y),Te(M,Y,null),s[31](S),Ne(n,x,g),Te(f,n,g),j=!0,E||(L=ot(S,"scroll",s[32]),E=!0)},p(n,g){var ne;(!j||g[0]&33280)&&se!==(se=`
		`+(n[9]?`${n[9].length>30?`${n[9].slice(0,30)}...`:n[9]} | ${n[15]}`:`${n[15]}`)+`
	`)&&(He.title=se);const P={};g[0]&512&&(P.title=n[9]),g[0]&4096&&(P.shareEnabled=n[12].length>0),g[0]&256&&(P.chat=n[8]),!b&&g[0]&1&&(b=!0,P.selectedModels=n[0],F(()=>b=!1)),!U&&g[0]&16&&(U=!0,P.showModelSelector=n[4],F(()=>U=!1)),t.$set(P);const k={};g[0]&8192&&(k.chatId=n[13]),g[0]&1&&(k.selectedModels=n[0]),g[0]&128&&(k.selectedModelfiles=n[7]),g[0]&2048&&(k.bottomPadding=n[11].length>0),g[0]&16448&&(k.suggestionPrompts=((ne=n[6])==null?void 0:ne.suggestionPrompts)??n[14].default_prompt_suggestions),!le&&g[0]&2&&(le=!0,k.history=n[1],F(()=>le=!1)),!T&&g[0]&4096&&(T=!0,k.messages=n[12],F(()=>T=!1)),!I&&g[0]&4&&(I=!0,k.autoScroll=n[2],F(()=>I=!1)),!C&&g[0]&1024&&(C=!0,k.prompt=n[10],F(()=>C=!1)),M.$set(k),(!j||g[0]&65536&&B!==(B="min-h-screen max-h-screen "+(n[16]?"lg:max-w-[calc(100%-260px)]":"")+" w-full max-w-full flex flex-col"))&&ue(_,"class",B);const q={};g[0]&4096&&(q.messages=n[12]),!z&&g[0]&2048&&(z=!0,q.files=n[11],F(()=>z=!1)),!A&&g[0]&1024&&(A=!0,q.prompt=n[10],F(()=>A=!1)),!ae&&g[0]&4&&(ae=!0,q.autoScroll=n[2],F(()=>ae=!1)),!J&&g[0]&32&&(J=!0,q.selectedModel=n[5],F(()=>J=!1)),f.$set(q)},i(n){j||(Be(t.$$.fragment,n),Be(M.$$.fragment,n),Be(f.$$.fragment,n),j=!0)},o(n){Le(t.$$.fragment,n),Le(M.$$.fragment,n),Le(f.$$.fragment,n),j=!1},d(n){n&&(oe(o),oe(_),oe(x)),qe(t),qe(M),s[31](null),qe(f,n),E=!1,L()}}}let Ct="";function Et(s,se,o){let _,t,b,U,G,y,S,Y,M;Z(s,Ce,e=>o(13,_=e)),Z(s,je,e=>o(40,t=e)),Z(s,ut,e=>o(42,U=e)),Z(s,it,e=>o(43,G=e)),Z(s,pt,e=>o(14,y=e)),Z(s,ft,e=>o(24,S=e)),Z(s,dt,e=>o(15,Y=e)),Z(s,mt,e=>o(16,M=e));const le=st("i18n");Z(s,le,e=>o(41,b=e));let T=!1,I=!0,C,B=null,x=!0,f=[""],z="",A=null,ae={},J=null,j="",E="",L=[],i=[],a={messages:{},currentId:null};nt(async()=>{await re()});const re=async()=>{var d;B!==null&&(await ze(localStorage.token,B),B=null),window.history.replaceState(a.state,"","/"),await Ce.set(""),o(2,I=!0),o(9,j=""),o(12,i=[]),o(1,a={messages:{},currentId:null}),G.url.searchParams.get("models")?o(0,f=(d=G.url.searchParams.get("models"))==null?void 0:d.split(",")):t!=null&&t.models?o(0,f=t==null?void 0:t.models):y!=null&&y.default_models?o(0,f=y==null?void 0:y.default_models.split(",")):o(0,f=[""]),G.url.searchParams.get("q")&&(o(10,E=G.url.searchParams.get("q")??""),E&&(await D(),we(E))),o(0,f=f.map(m=>U.map(l=>l.id).includes(m)?m:""));let e=JSON.parse(localStorage.getItem("settings")??"{}");je.set({...e});const c=document.getElementById("chat-textarea");setTimeout(()=>c==null?void 0:c.focus(),0)},K=async()=>{await D(),C&&o(3,C.scrollTop=C.scrollHeight,C)},we=async(e,c=null)=>{if(console.log("submitPrompt",_),o(0,f=f.map(d=>U.map(m=>m.id).includes(d)?d:"")),f.includes(""))R.error(b.t("Model not selected"));else if(i.length!=0&&i.at(-1).done!=!0)console.log("wait");else if(L.length>0&&L.filter(d=>d.upload_status===!1).length>0)R.error(b.t("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready."));else{document.getElementById("chat-textarea").style.height="";let d=Ge(),m={id:d,parentId:i.length!==0?i.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:L.length>0?L:void 0,timestamp:Math.floor(Date.now()/1e3)};o(1,a.messages[d]=m,a),o(1,a.currentId=d,a),i.length!==0&&a.messages[i.at(-1).id].childrenIds.push(d),await D(),i.length==1&&(t.saveChatHistory??!0?(o(8,J=await bt(localStorage.token,{id:_,title:b.t("New Chat"),models:f,system:t.system??void 0,options:{...t.options??{}},messages:i,history:a,tags:[],timestamp:Date.now()})),await he.set(await _e(localStorage.token)),await Ce.set(J.id)):await Ce.set("local"),await D()),o(10,E=""),o(11,L=[]),await pe(e,d)}},pe=async(e,c)=>{const d=JSON.parse(JSON.stringify(_));await Promise.all((z!==""?[z.id]:f).map(async m=>{console.log("modelId",m);const l=U.filter(u=>u.id===m).at(0);if(l){let u=Ge(),v={parentId:c,id:u,childrenIds:[],role:"assistant",content:"",model:l.id,timestamp:Math.floor(Date.now()/1e3)};o(1,a.messages[u]=v,a),o(1,a.currentId=u,a),c!==null&&o(1,a.messages[c].childrenIds=[...a.messages[c].childrenIds,u],a),l!=null&&l.external?await $(l,e,u,d):l&&await be(l,e,u,d)}else R.error(b.t("Model {{modelId}} not found",{modelId:m}))})),await he.set(await _e(localStorage.token))},be=async(e,c,d,m)=>{var X,me;e=e.id;const l=a.messages[d];await D(),K();const u=[t.system?{role:"system",content:t.system}:void 0,...i].filter(p=>p).map((p,O,ce)=>{var r;const h={role:p.role,content:ce.length-2!==O?p.content:(p==null?void 0:p.raContent)??p.content},N=(r=p.files)==null?void 0:r.filter(W=>W.type==="image").map(W=>W.url.slice(W.url.indexOf(",")+1));return N&&N.length>0&&p.role==="user"&&(h.images=N),h});let v=-1;u.forEach((p,O)=>{p.images&&(v=O)}),u.forEach((p,O)=>{O!==v&&delete p.images});const Q=i.filter(p=>(p==null?void 0:p.files)??null).map(p=>p.files.filter(O=>O.type==="doc"||O.type==="collection")).flat(1),[w,ie]=await wt(localStorage.token,{model:e,messages:u,options:{...t.options??{},stop:((X=t==null?void 0:t.options)==null?void 0:X.stop)??void 0?t.options.stop.map(p=>decodeURIComponent(JSON.parse('"'+p.replace(/\"/g,'\\"')+'"'))):void 0},format:t.requestFormat??void 0,keep_alive:t.keepAlive??void 0,docs:Q.length>0?Q:void 0,citations:Q.length>0});if(w&&w.ok){console.log("controller",ie);const p=w.body.pipeThrough(new TextDecoderStream).pipeThrough(gt(`
`)).getReader();for(;;){const{value:O,done:ce}=await p.read();if(ce||T||m!==_){l.done=!0,o(12,i),o(1,a),T&&(ie.abort("User: Stop Response"),await ze(localStorage.token,B)),B=null;break}try{let h=O.split(`
`);for(const N of h)if(N!==""){console.log(N);let r=JSON.parse(N);if("citations"in r){l.citations=r.citations;continue}if("detail"in r)throw r;if("id"in r)console.log(r),B=r.id;else if(r.done==!1){if(l.content==""&&r.message.content==`
`)continue;l.content+=r.message.content,o(12,i),o(1,a)}else{if(l.done=!0,l.content==""&&(l.error=!0,l.content="Oops! No text generated from Ollama, Please try again."),l.context=r.context??null,l.info={total_duration:r.total_duration,load_duration:r.load_duration,sample_count:r.sample_count,sample_duration:r.sample_duration,prompt_eval_count:r.prompt_eval_count,prompt_eval_duration:r.prompt_eval_duration,eval_count:r.eval_count,eval_duration:r.eval_duration},o(12,i),o(1,a),t.notificationEnabled&&!document.hasFocus()){const W=new Notification(A?`${A.title.charAt(0).toUpperCase()+A.title.slice(1)}`:`${e}`,{body:l.content,icon:(A==null?void 0:A.imageUrl)??`${We}/static/favicon.png`})}t.responseAutoCopy&&Ye(l.content),t.responseAutoPlayback&&(await D(),(me=document.getElementById(`speak-button-${l.id}`))==null||me.click())}}}catch(h){console.log(h),"detail"in h&&R.error(h.detail);break}I&&K()}_==m&&(t.saveChatHistory??!0)&&(o(8,J=await De(localStorage.token,m,{messages:i,history:a})),await he.set(await _e(localStorage.token)))}else{if(w!==null){const p=await w.json();console.log(p),"detail"in p?(R.error(p.detail),l.content=p.detail):(R.error(p.error),l.content=p.error)}else R.error(b.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"})),l.content=b.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"});l.error=!0,l.content=b.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"}),l.done=!0,o(12,i),o(1,a)}if(T=!1,await D(),I&&K(),i.length==2&&i.at(1).content!==""){window.history.replaceState(a.state,"",`/c/${m}`);const p=await ee(c);await de(m,p)}},$=async(e,c,d,m)=>{var v,Q,w,ie,X,me,p,O,ce;const l=a.messages[d],u=i.filter(h=>(h==null?void 0:h.files)??null).map(h=>h.files.filter(N=>N.type==="doc"||N.type==="collection")).flat(1);console.log(u),K();try{const[h,N]=await ht(localStorage.token,{model:e.id,stream:!0,messages:[t.system?{role:"system",content:t.system}:void 0,...i].filter(r=>r).map((r,W,ge)=>{var ye;return{role:r.role,...((ye=r.files)==null?void 0:ye.filter(te=>te.type==="image").length)>0&&r.role==="user"?{content:[{type:"text",text:ge.length-1!==W?r.content:(r==null?void 0:r.raContent)??r.content},...r.files.filter(te=>te.type==="image").map(te=>({type:"image_url",image_url:{url:te.url}}))]}:{content:ge.length-1!==W?r.content:(r==null?void 0:r.raContent)??r.content}}}),seed:((v=t==null?void 0:t.options)==null?void 0:v.seed)??void 0,stop:((Q=t==null?void 0:t.options)==null?void 0:Q.stop)??void 0?t.options.stop.map(r=>decodeURIComponent(JSON.parse('"'+r.replace(/\"/g,'\\"')+'"'))):void 0,temperature:((w=t==null?void 0:t.options)==null?void 0:w.temperature)??void 0,top_p:((ie=t==null?void 0:t.options)==null?void 0:ie.top_p)??void 0,num_ctx:((X=t==null?void 0:t.options)==null?void 0:X.num_ctx)??void 0,frequency_penalty:((me=t==null?void 0:t.options)==null?void 0:me.repeat_penalty)??void 0,max_tokens:((p=t==null?void 0:t.options)==null?void 0:p.num_predict)??void 0,docs:u.length>0?u:void 0,citations:u.length>0},((O=e==null?void 0:e.source)==null?void 0:O.toLowerCase())==="litellm"?`${Fe}/v1`:`${Ve}`);if(await D(),K(),h&&h.ok&&h.body){const r=await Mt(h.body,t.splitLargeChunks);for await(const W of r){const{value:ge,done:ye,citations:te,error:Je}=W;if(Je){await fe(Je,null,e,l);break}if(ye||T||m!==_){l.done=!0,o(12,i),o(1,a),T&&N.abort("User: Stop Response");break}if(te){l.citations=te;continue}if(!(l.content==""&&ge==`
`)){if(l.content+=ge,o(12,i),o(1,a),t.notificationEnabled&&!document.hasFocus()){const Pt=new Notification(`OpenAI ${e}`,{body:l.content,icon:`${We}/static/favicon.png`})}t.responseAutoCopy&&Ye(l.content),t.responseAutoPlayback&&(await D(),(ce=document.getElementById(`speak-button-${l.id}`))==null||ce.click()),I&&K()}}_==m&&(t.saveChatHistory??!0)&&(o(8,J=await De(localStorage.token,m,{messages:i,history:a})),await he.set(await _e(localStorage.token)))}else await fe(null,h,e,l)}catch(h){await fe(h,null,e,l)}if(o(12,i),o(1,a),T=!1,await D(),I&&K(),i.length==2){window.history.replaceState(a.state,"",`/c/${m}`);const h=await ee(c);await de(m,h)}},fe=async(e,c,d,m)=>{let l="",u;e?u=e:c!==null&&(u=await c.json()),console.error(u),"detail"in u?(R.error(u.detail),l=u.detail):"error"in u?"message"in u.error?(R.error(u.error.message),l=u.error.message):(R.error(u.error),l=u.error):"message"in u&&(R.error(u.message),l=u.message),m.error=!0,m.content=b.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:d.name??d.id})+`
`+l,m.done=!0,o(12,i),o(1,a)},Ee=()=>{T=!0,console.log("stopResponse")},Pe=async()=>{if(console.log("regenerateResponse"),i.length!=0&&i.at(-1).done==!0){i.splice(i.length-1,1),o(12,i),o(1,a);let e=i.at(-1),c=e.content;await pe(c,e.id)}},ve=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(_));if(i.length!=0&&i.at(-1).done==!0){const c=a.messages[a.currentId];c.done=!1,await D();const d=U.filter(m=>m.id===c.model).at(0);d&&(d!=null&&d.external?await $(d,a.messages[c.parentId].content,c.id,e):await be(d,a.messages[c.parentId].content,c.id,e))}else R.error(b.t("Model {{modelId}} not found",{modelId}))},ee=async e=>{var c,d,m,l,u;if(((c=t==null?void 0:t.title)==null?void 0:c.auto)??!0){const v=U.find(X=>X.id===f[0]),Q=(v==null?void 0:v.external)??!1?((d=t==null?void 0:t.title)==null?void 0:d.modelExternal)??f[0]:((m=t==null?void 0:t.title)==null?void 0:m.model)??f[0],w=U.find(X=>X.id===Q);return console.log(w),await _t(localStorage.token,((l=t==null?void 0:t.title)==null?void 0:l.prompt)??b.t("Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title':")+" {{prompt}}",Q,e,(w==null?void 0:w.external)??!1?((u=w==null?void 0:w.source)==null?void 0:u.toLowerCase())==="litellm"?`${Fe}/v1`:`${Ve}`:`${ct}/v1`)}else return`${e}`},de=async(e,c)=>{e===_&&o(9,j=c),(t.saveChatHistory??!0)&&(o(8,J=await De(localStorage.token,e,{title:c})),await he.set(await _e(localStorage.token)))};function n(e){f=e,o(0,f)}function g(e){x=e,o(4,x)}function P(e){a=e,o(1,a)}function k(e){i=e,o(12,i),o(1,a)}function q(e){I=e,o(2,I)}function ne(e){E=e,o(10,E)}function Ke(e){H[e?"unshift":"push"](()=>{C=e,o(3,C)})}const Qe=e=>{o(2,I=C.scrollHeight-C.scrollTop<=C.clientHeight+5)};function Xe(e){L=e,o(11,L)}function Ze(e){E=e,o(10,E)}function xe(e){I=e,o(2,I)}function $e(e){z=e,o(5,z)}return s.$$.update=()=>{if(s.$$.dirty[0]&16777217&&o(6,A=f.length===1&&S.filter(e=>e.tagName===f[0]).length>0?S.filter(e=>e.tagName===f[0])[0]:null),s.$$.dirty[0]&16777217&&o(7,ae=f.reduce((e,c,d,m)=>{var u;const l=((u=S.filter(v=>v.tagName===c))==null?void 0:u.at(0))??void 0;return{...e,...l&&{[c]:l}}},{})),s.$$.dirty[0]&2)if(a.currentId!==null){let e=[],c=a.messages[a.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?a.messages[c.parentId]:null;o(12,i=e)}else o(12,i=[])},[f,a,I,C,x,z,A,ae,J,j,E,L,i,_,y,Y,M,le,re,we,pe,Ee,Pe,ve,S,n,g,P,k,q,ne,Ke,Qe,Xe,Ze,xe,$e]}class Wt extends lt{constructor(se){super(),at(this,se,Et,kt,et,{},null,[-1,-1])}}export{Wt as component};
