import{s as at,a as Be,e as De,M as lt,d as Q,c as Le,i as Ee,w as Y,P as rt,o as it,p as F,f as Se,g as Me,h as Ie,j as ie,r as ke,u as ct,Y as z,t as N}from"../chunks/scheduler.7238b518.js";import{S as ut,i as ft,a as ce,t as _e,c as pt,f as K,b as Ae,d as Ne,m as Pe,e as Te,g as dt}from"../chunks/index.4c8b96e2.js";import{g as mt}from"../chunks/globals.7f7f1b26.js";import{a as L}from"../chunks/Toaster.svelte_svelte_type_style_lang.93775e0f.js";import{g as ve}from"../chunks/navigation.a73d356d.js";import{p as gt}from"../chunks/stores.2e15bc6d.js";import{d as Je,g as Ce,m as ht,j as _t,W as wt,h as yt,c as bt,e as ge,a as qe,L as je,O as We,l as St}from"../chunks/index.bf1cda65.js";import{v as Fe,s as Mt,a as Ve,n as It,o as kt,p as vt}from"../chunks/index.2773335b.js";import{h as Ct,c as Ge}from"../chunks/index.295018b5.js";import{c as Et,b as he,u as Re,i as Ot,m as At}from"../chunks/index.8cf31506.js";import{N as Nt,M as Pt,c as Tt}from"../chunks/index.b80ad461.js";import{M as Rt}from"../chunks/Messages.c2dd6758.js";const{document:Ue}=mt;function Ye(o){var ae;let S,t,s,y,p,d,b,P,k,te,oe,se,$,T,_,v,H,ee,M,D,R,ue;function J(n){o[28](n)}function fe(n){o[29](n)}let X={title:o[11],chat:o[10],shareEnabled:o[14].length>0,initNewChat:o[27]};o[0]!==void 0&&(X.selectedModels=o[0]),o[6]!==void 0&&(X.showModelSelector=o[6]),t=new Nt({props:X}),F.push(()=>K(t,"selectedModels",J)),F.push(()=>K(t,"showModelSelector",fe));function q(n){o[30](n)}function i(n){o[31](n)}function l(n){o[32](n)}let ne={chatId:o[15],selectedModels:o[0],selectedModelfiles:o[9],processing:Bt,bottomPadding:o[13].length>0,sendPrompt:o[21],continueGeneration:o[24],regenerateResponse:o[23]};o[1]!==void 0&&(ne.history=o[1]),o[14]!==void 0&&(ne.messages=o[14]),o[3]!==void 0&&(ne.autoScroll=o[3]),k=new Rt({props:ne}),F.push(()=>K(k,"history",q)),F.push(()=>K(k,"messages",i)),F.push(()=>K(k,"autoScroll",l));function j(n){o[35](n)}function Oe(n){o[36](n)}function pe(n){o[37](n)}function we(n){o[38](n)}let Z={suggestionPrompts:((ae=o[8])==null?void 0:ae.suggestionPrompts)??o[18].default_prompt_suggestions,messages:o[14],submitPrompt:o[20],stopResponse:o[22]};return o[13]!==void 0&&(Z.files=o[13]),o[12]!==void 0&&(Z.prompt=o[12]),o[3]!==void 0&&(Z.autoScroll=o[3]),o[7]!==void 0&&(Z.selectedModel=o[7]),_=new Pt({props:Z}),F.push(()=>K(_,"files",j)),F.push(()=>K(_,"prompt",Oe)),F.push(()=>K(_,"autoScroll",pe)),F.push(()=>K(_,"selectedModel",we)),{c(){S=Se("div"),Ae(t.$$.fragment),p=Be(),d=Se("div"),b=Se("div"),P=Se("div"),Ae(k.$$.fragment),T=Be(),Ae(_.$$.fragment),this.h()},l(n){S=Me(n,"DIV",{class:!0});var m=Ie(S);Ne(t.$$.fragment,m),p=Le(m),d=Me(m,"DIV",{class:!0});var U=Ie(d);b=Me(U,"DIV",{class:!0,id:!0});var C=Ie(b);P=Me(C,"DIV",{class:!0});var E=Ie(P);Ne(k.$$.fragment,E),E.forEach(Q),C.forEach(Q),U.forEach(Q),m.forEach(Q),T=Le(n),Ne(_.$$.fragment,n),this.h()},h(){ie(P,"class","h-full w-full flex flex-col py-4"),ie(b,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0 max-w-full"),ie(b,"id","messages-container"),ie(d,"class","flex flex-col flex-auto"),ie(S,"class",$="min-h-screen max-h-screen "+(o[17]?"lg:max-w-[calc(100%-260px)]":"")+" w-full max-w-full flex flex-col")},m(n,m){Ee(n,S,m),Pe(t,S,null),ke(S,p),ke(S,d),ke(d,b),ke(b,P),Pe(k,P,null),o[33](b),Ee(n,T,m),Pe(_,n,m),D=!0,R||(ue=ct(b,"scroll",o[34]),R=!0)},p(n,m){var ye;const U={};m[0]&2048&&(U.title=n[11]),m[0]&1024&&(U.chat=n[10]),m[0]&16384&&(U.shareEnabled=n[14].length>0),m[0]&32&&(U.initNewChat=n[27]),!s&&m[0]&1&&(s=!0,U.selectedModels=n[0],z(()=>s=!1)),!y&&m[0]&64&&(y=!0,U.showModelSelector=n[6],z(()=>y=!1)),t.$set(U);const C={};m[0]&32768&&(C.chatId=n[15]),m[0]&1&&(C.selectedModels=n[0]),m[0]&512&&(C.selectedModelfiles=n[9]),m[0]&8192&&(C.bottomPadding=n[13].length>0),!te&&m[0]&2&&(te=!0,C.history=n[1],z(()=>te=!1)),!oe&&m[0]&16384&&(oe=!0,C.messages=n[14],z(()=>oe=!1)),!se&&m[0]&8&&(se=!0,C.autoScroll=n[3],z(()=>se=!1)),k.$set(C),(!D||m[0]&131072&&$!==($="min-h-screen max-h-screen "+(n[17]?"lg:max-w-[calc(100%-260px)]":"")+" w-full max-w-full flex flex-col"))&&ie(S,"class",$);const E={};m[0]&262400&&(E.suggestionPrompts=((ye=n[8])==null?void 0:ye.suggestionPrompts)??n[18].default_prompt_suggestions),m[0]&16384&&(E.messages=n[14]),!v&&m[0]&8192&&(v=!0,E.files=n[13],z(()=>v=!1)),!H&&m[0]&4096&&(H=!0,E.prompt=n[12],z(()=>H=!1)),!ee&&m[0]&8&&(ee=!0,E.autoScroll=n[3],z(()=>ee=!1)),!M&&m[0]&128&&(M=!0,E.selectedModel=n[7],z(()=>M=!1)),_.$set(E)},i(n){D||(ce(t.$$.fragment,n),ce(k.$$.fragment,n),ce(_.$$.fragment,n),D=!0)},o(n){_e(t.$$.fragment,n),_e(k.$$.fragment,n),_e(_.$$.fragment,n),D=!1},d(n){n&&(Q(S),Q(T)),Te(t),Te(k),o[33](null),Te(_,n),R=!1,ue()}}}function Ut(o){let S,t,s,y;Ue.title=S=`
		`+(o[11]?`${o[11].length>30?`${o[11].slice(0,30)}...`:o[11]} | ${o[16]}`:`${o[16]}`)+`
	`;let p=o[2]&&Ye(o);return{c(){t=Be(),p&&p.c(),s=De()},l(d){lt("svelte-1123lr8",Ue.head).forEach(Q),t=Le(d),p&&p.l(d),s=De()},m(d,b){Ee(d,t,b),p&&p.m(d,b),Ee(d,s,b),y=!0},p(d,b){(!y||b[0]&67584)&&S!==(S=`
		`+(d[11]?`${d[11].length>30?`${d[11].slice(0,30)}...`:d[11]} | ${d[16]}`:`${d[16]}`)+`
	`)&&(Ue.title=S),d[2]?p?(p.p(d,b),b[0]&4&&ce(p,1)):(p=Ye(d),p.c(),ce(p,1),p.m(s.parentNode,s)):p&&(dt(),_e(p,1,1,()=>{p=null}),pt())},i(d){y||(ce(p),y=!0)},o(d){_e(p),y=!1},d(d){d&&(Q(t),Q(s)),p&&p.d(d)}}}let Bt="";function Lt(o,S,t){let s,y,p,d,b,P,k,te,oe;Y(o,Je,e=>t(41,s=e)),Y(o,Ce,e=>t(15,y=e)),Y(o,ht,e=>t(43,d=e)),Y(o,gt,e=>t(25,b=e)),Y(o,_t,e=>t(26,P=e)),Y(o,wt,e=>t(16,k=e)),Y(o,yt,e=>t(17,te=e)),Y(o,bt,e=>t(18,oe=e));const se=rt("i18n");Y(o,se,e=>t(42,p=e));let $=!1,T=!1,_=!0,v,H=null,ee=!0,M=[""],D="",R=null,ue={},J=null,fe="",X="",q=[],i=[],l={messages:{},currentId:null};const ne=async()=>{if(await Ce.set(b.params.id),t(10,J=await Ot(localStorage.token,y).catch(async e=>(await ve("/"),null))),J){await ye();const e=J.chat;if(e){console.log(e),t(0,M=((e==null?void 0:e.models)??void 0)!==void 0?e.models:[e.models??""]),t(1,l=((e==null?void 0:e.history)??void 0)!==void 0?e.history:vt(e.messages)),t(11,fe=e.title);let c=JSON.parse(localStorage.getItem("settings")??"{}");return await Je.set({...c,system:e.system??c.system,options:e.options??c.options}),t(3,_=!0),await N(),i.length>0&&t(1,l.messages[i.at(-1).id].done=!0,l),await N(),!0}else return null}},j=async()=>{await N(),v&&t(4,v.scrollTop=v.scrollHeight,v)},Oe=async(e,c=null)=>{if(console.log("submitPrompt",y),M.includes(""))L.error(p.t("Model not selected"));else if(i.length!=0&&i.at(-1).done!=!0)console.log("wait");else if(q.length>0&&q.filter(g=>g.upload_status===!1).length>0)L.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let g=Fe(),h={id:g,parentId:i.length!==0?i.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:q.length>0?q:void 0,timestamp:Math.floor(Date.now()/1e3)};t(1,l.messages[g]=h,l),t(1,l.currentId=g,l),i.length!==0&&l.messages[i.at(-1).id].childrenIds.push(g),await N(),i.length==1&&(s.saveChatHistory??!0?(t(10,J=await Et(localStorage.token,{id:y,title:p.t("New Chat"),models:M,system:s.system??void 0,options:{...s.options??{}},messages:i,history:l,timestamp:Date.now()})),await ge.set(await he(localStorage.token)),await Ce.set(J.id)):await Ce.set("local"),await N()),t(12,X=""),t(13,q=[]),await pe(e,g)}},pe=async(e,c)=>{const g=JSON.parse(JSON.stringify(y));await Promise.all((D!==""?[D.id]:M).map(async h=>{const a=d.filter(u=>u.id===h).at(0);if(a){let u=Fe(),O={parentId:c,id:u,childrenIds:[],role:"assistant",content:"",model:a.id,timestamp:Math.floor(Date.now()/1e3)};t(1,l.messages[u]=O,l),t(1,l.currentId=u,l),c!==null&&t(1,l.messages[c].childrenIds=[...l.messages[c].childrenIds,u],l),a!=null&&a.external?await Z(a,e,u,g):a&&await we(a,e,u,g)}else L.error(p.t("Model {{modelId}} not found",{modelId:h}))})),await ge.set(await he(localStorage.token))},we=async(e,c,g,h)=>{var G,de;e=e.id;const a=l.messages[g];await N(),j();const u=[s.system?{role:"system",content:s.system}:void 0,...i].filter(f=>f).map((f,A,re)=>{var r;const w={role:f.role,content:re.length-2!==A?f.content:(f==null?void 0:f.raContent)??f.content},B=(r=f.files)==null?void 0:r.filter(W=>W.type==="image").map(W=>W.url.slice(W.url.indexOf(",")+1));return B&&B.length>0&&f.role==="user"&&(w.images=B),w});let O=-1;u.forEach((f,A)=>{f.images&&(O=A)}),u.forEach((f,A)=>{A!==O&&delete f.images});const V=i.filter(f=>(f==null?void 0:f.files)??null).map(f=>f.files.filter(A=>A.type==="doc"||A.type==="collection")).flat(1),[I,le]=await Ct(localStorage.token,{model:e,messages:u,options:{...s.options??{},stop:((G=s==null?void 0:s.options)==null?void 0:G.stop)??void 0?s.options.stop.map(f=>decodeURIComponent(JSON.parse('"'+f.replace(/\"/g,'\\"')+'"'))):void 0},format:s.requestFormat??void 0,keep_alive:s.keepAlive??void 0,docs:V.length>0?V:void 0,citations:V.length>0});if(I&&I.ok){console.log("controller",le);const f=I.body.pipeThrough(new TextDecoderStream).pipeThrough(Mt(`
`)).getReader();for(;;){const{value:A,done:re}=await f.read();if(re||T||h!==y){a.done=!0,t(14,i),t(1,l),T&&(le.abort("User: Stop Response"),await Ge(localStorage.token,H)),t(5,H=null);break}try{let w=A.split(`
`);for(const B of w)if(B!==""){console.log(B);let r=JSON.parse(B);if("citations"in r){a.citations=r.citations;continue}if("detail"in r)throw r;if("id"in r)console.log(r),t(5,H=r.id);else if(r.done==!1){if(a.content==""&&r.message.content==`
`)continue;a.content+=r.message.content,t(14,i),t(1,l)}else{if(a.done=!0,a.content==""&&(a.error=!0,a.content="Oops! No text generated from Ollama, Please try again."),a.context=r.context??null,a.info={total_duration:r.total_duration,load_duration:r.load_duration,sample_count:r.sample_count,sample_duration:r.sample_duration,prompt_eval_count:r.prompt_eval_count,prompt_eval_duration:r.prompt_eval_duration,eval_count:r.eval_count,eval_duration:r.eval_duration},t(14,i),t(1,l),s.notificationEnabled&&!document.hasFocus()){const W=new Notification(R?`${R.title.charAt(0).toUpperCase()+R.title.slice(1)}`:`${e}`,{body:a.content,icon:(R==null?void 0:R.imageUrl)??`${qe}/static/favicon.png`})}s.responseAutoCopy&&Ve(a.content),s.responseAutoPlayback&&(await N(),(de=document.getElementById(`speak-button-${a.id}`))==null||de.click())}}}catch(w){console.log(w),"detail"in w&&L.error(w.detail);break}_&&j()}y==h&&(s.saveChatHistory??!0)&&(t(10,J=await Re(localStorage.token,h,{messages:i,history:l})),await ge.set(await he(localStorage.token)))}else{if(I!==null){const f=await I.json();console.log(f),"detail"in f?(L.error(f.detail),a.content=f.detail):(L.error(f.error),a.content=f.error)}else L.error(p.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"})),a.content=p.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"});a.error=!0,a.content=p.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:"Ollama"}),a.done=!0,t(14,i),t(1,l)}if(T=!1,await N(),_&&j(),i.length==2&&i.at(1).content!==""){window.history.replaceState(l.state,"",`/c/${h}`);const f=await C(c);await E(h,f)}},Z=async(e,c,g,h)=>{var O,V,I,le,G,de,f,A,re;const a=l.messages[g],u=i.filter(w=>(w==null?void 0:w.files)??null).map(w=>w.files.filter(B=>B.type==="doc"||B.type==="collection")).flat(1);console.log(u),j();try{const[w,B]=await It(localStorage.token,{model:e.id,stream:!0,messages:[s.system?{role:"system",content:s.system}:void 0,...i].filter(r=>r).map((r,W,me)=>{var be;return{role:r.role,...((be=r.files)==null?void 0:be.filter(x=>x.type==="image").length)>0&&r.role==="user"?{content:[{type:"text",text:me.length-1!==W?r.content:(r==null?void 0:r.raContent)??r.content},...r.files.filter(x=>x.type==="image").map(x=>({type:"image_url",image_url:{url:x.url}}))]}:{content:me.length-1!==W?r.content:(r==null?void 0:r.raContent)??r.content}}}),seed:((O=s==null?void 0:s.options)==null?void 0:O.seed)??void 0,stop:((V=s==null?void 0:s.options)==null?void 0:V.stop)??void 0?s.options.stop.map(r=>decodeURIComponent(JSON.parse('"'+r.replace(/\"/g,'\\"')+'"'))):void 0,temperature:((I=s==null?void 0:s.options)==null?void 0:I.temperature)??void 0,top_p:((le=s==null?void 0:s.options)==null?void 0:le.top_p)??void 0,num_ctx:((G=s==null?void 0:s.options)==null?void 0:G.num_ctx)??void 0,frequency_penalty:((de=s==null?void 0:s.options)==null?void 0:de.repeat_penalty)??void 0,max_tokens:((f=s==null?void 0:s.options)==null?void 0:f.num_predict)??void 0,docs:u.length>0?u:void 0,citations:u.length>0},((A=e==null?void 0:e.source)==null?void 0:A.toLowerCase())==="litellm"?`${je}/v1`:`${We}`);if(await N(),j(),w&&w.ok&&w.body){const r=await Tt(w.body,s.splitLargeChunks);for await(const W of r){const{value:me,done:be,citations:x,error:He}=W;if(He){await ae(He,null,e,a);break}if(be||T||h!==y){a.done=!0,t(14,i),t(1,l),T&&B.abort("User: Stop Response");break}if(x){a.citations=x;continue}if(!(a.content==""&&me==`
`)){if(a.content+=me,t(14,i),t(1,l),s.notificationEnabled&&!document.hasFocus()){const Ht=new Notification(`OpenAI ${e}`,{body:a.content,icon:`${qe}/static/favicon.png`})}s.responseAutoCopy&&Ve(a.content),s.responseAutoPlayback&&(await N(),(re=document.getElementById(`speak-button-${a.id}`))==null||re.click()),_&&j()}}y==h&&(s.saveChatHistory??!0)&&(t(10,J=await Re(localStorage.token,h,{messages:i,history:l})),await ge.set(await he(localStorage.token)))}else await ae(null,w,e,a)}catch(w){await ae(w,null,e,a)}if(T=!1,await N(),_&&j(),i.length==2){window.history.replaceState(l.state,"",`/c/${h}`);const w=await C(c);await E(h,w)}},ae=async(e,c,g,h)=>{let a="",u;e?u=e:c!==null&&(u=await c.json()),console.error(u),"detail"in u?(L.error(u.detail),a=u.detail):"error"in u?"message"in u.error?(L.error(u.error.message),a=u.error.message):(L.error(u.error),a=u.error):"message"in u&&(L.error(u.message),a=u.message),h.error=!0,h.content=p.t("Uh-oh! There was an issue connecting to {{provider}}.",{provider:g.name??g.id})+`
`+a,h.done=!0,t(14,i),t(1,l)},n=()=>{T=!0,console.log("stopResponse")},m=async()=>{if(console.log("regenerateResponse"),i.length!=0&&i.at(-1).done==!0){i.splice(i.length-1,1),t(14,i),t(1,l);let e=i.at(-1),c=e.content;await pe(c,e.id)}},U=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(y));if(i.length!=0&&i.at(-1).done==!0){const c=l.messages[l.currentId];c.done=!1,await N();const g=d.filter(h=>h.id===c.model).at(0);g&&(g!=null&&g.external?await Z(g,l.messages[c.parentId].content,c.id,e):await we(g,l.messages[c.parentId].content,c.id,e))}else L.error(p.t("Model {{modelId}} not found",{modelId}))},C=async e=>{var c,g,h,a,u;if(((c=s==null?void 0:s.title)==null?void 0:c.auto)??!0){const O=d.find(G=>G.id===M[0]),V=(O==null?void 0:O.external)??!1?((g=s==null?void 0:s.title)==null?void 0:g.modelExternal)??M[0]:((h=s==null?void 0:s.title)==null?void 0:h.model)??M[0],I=d.find(G=>G.id===V);return console.log(I),await kt(localStorage.token,((a=s==null?void 0:s.title)==null?void 0:a.prompt)??p.t("Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title':")+" {{prompt}}",V,e,(I==null?void 0:I.external)??!1?((u=I==null?void 0:I.source)==null?void 0:u.toLowerCase())==="litellm"?`${je}/v1`:`${We}`:`${St}/v1`)}else return`${e}`},E=async(e,c)=>{e===y&&t(11,fe=c),(s.saveChatHistory??!0)&&(t(10,J=await Re(localStorage.token,e,{title:c})),await ge.set(await he(localStorage.token)))},ye=async()=>await At(localStorage.token,y).catch(async e=>[]);it(async()=>{(s.saveChatHistory??!0)||await ve("/")});const ze=async()=>{H!==null&&(await Ge(localStorage.token,H),t(5,H=null)),ve("/")};function Ke(e){M=e,t(0,M)}function Qe(e){ee=e,t(6,ee)}function Xe(e){l=e,t(1,l)}function Ze(e){i=e,t(14,i),t(1,l)}function xe(e){_=e,t(3,_)}function $e(e){F[e?"unshift":"push"](()=>{v=e,t(4,v)})}const et=e=>{t(3,_=v.scrollHeight-v.scrollTop<=v.clientHeight+5)};function tt(e){q=e,t(13,q)}function ot(e){X=e,t(12,X)}function st(e){_=e,t(3,_)}function nt(e){D=e,t(7,D)}return o.$$.update=()=>{if(o.$$.dirty[0]&67108865&&t(8,R=M.length===1&&P.filter(e=>e.tagName===M[0]).length>0?P.filter(e=>e.tagName===M[0])[0]:null),o.$$.dirty[0]&67108865&&t(9,ue=M.reduce((e,c,g,h)=>{var u;const a=((u=P.filter(O=>O.tagName===c))==null?void 0:u.at(0))??void 0;return{...e,...a&&{[c]:a}}},{})),o.$$.dirty[0]&2)if(l.currentId!==null){let e=[],c=l.messages[l.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?l.messages[c.parentId]:null;t(14,i=e)}else t(14,i=[]);o.$$.dirty[0]&33554432&&b.params.id&&(async()=>{if(await ne()){await N(),t(2,$=!0),window.setTimeout(()=>j(),0);const e=document.getElementById("chat-textarea");e==null||e.focus()}else await ve("/")})()},[M,l,$,_,v,H,ee,D,R,ue,J,fe,X,q,i,y,k,te,oe,se,Oe,pe,n,m,U,b,P,ze,Ke,Qe,Xe,Ze,xe,$e,et,tt,ot,st,nt]}class Xt extends ut{constructor(S){super(),ft(this,S,Lt,Ut,at,{},null,[-1,-1])}}export{Xt as component};
