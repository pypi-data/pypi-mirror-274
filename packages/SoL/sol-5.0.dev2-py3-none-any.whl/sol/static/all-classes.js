Ext.define('Ext.app.Application',{extend:'Ext.app.Controller',requires:['Ext.tip.QuickTipManager'],scope:undefined,enableQuickTips:true,appFolder:'app',appProperty:'app',namespaces:[],autoCreateViewport:false,paths:null,onClassExtended:function(cls,data,hooks){var Controller=Ext.app.Controller,proto=cls.prototype,requires=[],onBeforeClassCreated,paths,namespace,ns,appFolder;namespace=data.name||cls.superclass.name;appFolder=data.appFolder||cls.superclass.appFolder;if(namespace){data.$namespace=namespace;Ext.app.addNamespaces(namespace);}
if(data.namespaces){Ext.app.addNamespaces(data.namespaces);}
if(!data['paths processed']){if(namespace&&appFolder){Ext.Loader.setPath(namespace,appFolder);}
paths=data.paths;if(paths){for(ns in paths){if(paths.hasOwnProperty(ns)){Ext.Loader.setPath(ns,paths[ns]);}}}}
else{delete data['paths processed'];}
if(data.autoCreateViewport){Controller.processDependencies(proto,requires,namespace,'view',['Viewport']);}
if(requires.length){onBeforeClassCreated=hooks.onBeforeCreated;hooks.onBeforeCreated=function(cls,data){var args=Ext.Array.clone(arguments);Ext.require(requires,function(){return onBeforeClassCreated.apply(this,args);});};}},constructor:function(config){var me=this;me.callParent(arguments);me.doInit(me);me.initNamespace();me.initControllers();me.onBeforeLaunch();me.finishInitControllers();},initNamespace:function(){var me=this,appProperty=me.appProperty,ns;ns=Ext.namespace(me.name);if(ns){ns.getApplication=function(){return me;};if(appProperty){if(!ns[appProperty]){ns[appProperty]=me;}}}},initControllers:function(){var me=this,controllers=Ext.Array.from(me.controllers);me.controllers=new Ext.util.MixedCollection();for(var i=0,ln=controllers.length;i<ln;i++){me.getController(controllers[i]);}},finishInitControllers:function(){var me=this,controllers,i,l;controllers=me.controllers.getRange();for(i=0,l=controllers.length;i<l;i++){controllers[i].finishInit(me);}},launch:Ext.emptyFn,onBeforeLaunch:function(){var me=this,controllers,c,cLen,controller;if(me.enableQuickTips){me.initQuickTips();}
if(me.autoCreateViewport){me.initViewport();}
me.launch.call(me.scope||me);me.launched=true;me.fireEvent('launch',me);controllers=me.controllers.items;cLen=controllers.length;for(c=0;c<cLen;c++){controller=controllers[c];controller.onLaunch(me);}},getModuleClassName:function(name,kind){return Ext.app.Controller.getFullName(name,kind,this.name).absoluteName;},initQuickTips:function(){Ext.tip.QuickTipManager.init();},initViewport:function(){var viewport=this.getView('Viewport');if(viewport){viewport.create();}},getController:function(name){var me=this,controllers=me.controllers,className,controller;controller=controllers.get(name);if(!controller){className=me.getModuleClassName(name,'controller');controller=Ext.create(className,{application:me,id:name});controllers.add(controller);if(me._initialized){controller.doInit(me);}}
return controller;},getApplication:function(){return this;}});Ext.define('SoL.controller.Login',{extend:'MP.controller.Login',uses:['SoL.desktop.App','SoL.window.Login','SoL.window.LostPassword','SoL.window.Signin'],applicationClass:'SoL.desktop.App',init:function(){var me=this;me.callParent(arguments);me.control({'loginwindow button[action=signin]':{click:me.signin},'loginwindow button[action=lostpassword]':{click:me.lostPassword}});},_doCreateUserDesktop:function(user){var me=this;var app=MP.controller.Login.prototype.createUserDesktop.call(me,user);app.on('ready',function(){Ext.Ajax.request({url:'/data/countries',success:function(response){var result=Ext.decode(response.responseText);var root=result.root;var c,cd={};for(var i=0,l=result.count;i<l;i++){c=root[i];cd[c.code]=c.name;}
SoL.form.field.FlagsCombo.countries=cd;}});});},createUserDesktop:function(user){var me=this;var reload=user.reload_l10n;delete user.reload_l10n;if(reload){Ext.Loader.loadScript({url:'/catalog',onLoad:function(){Ext.Loader.loadScript({url:'/extjs-l10n',onLoad:function(){me._doCreateUserDesktop(user);}});}});}else{me._doCreateUserDesktop(user);}},signin:function(button){if(__signin__){Ext.create('SoL.window.Signin',{}).show();}},lostPassword:function(button){if(__password_reset__){Ext.create('SoL.window.LostPassword',{}).show();}}});Ext.define('SoL.window.ChangeLanguage',{extend:'Ext.Window',uses:'Ext.form.Panel',title:_('Change your account UI language'),titleAlign:'center',width:400,autoHeight:true,closable:true,resizable:false,draggable:false,layout:'fit',border:false,modal:true,currentLanguage:null,initComponent:function(){var me=this;Ext.apply(me,{items:[{xtype:'form',plain:true,frame:true,border:0,bodyPadding:5,url:'/auth/changeLanguage',fieldDefaults:{labelWidth:150},items:me.getFormFields()}]});me.callParent();},buttons:['->',{text:_("Confirm"),type:"submit",formBind:true,handler:function(button){var win=button.up('window'),panel=win.down('form'),form=panel.getForm();if(form.isValid()){panel.getEl().mask(_("Changing UI language…"));form.submit({success:function(f,a){Ext.Msg.show({title:_('Change succeeded'),msg:_('Your account UI language has been successfully updated, it will be used at your next login.'),icon:Ext.Msg.INFO,buttons:Ext.Msg.OK,fn:function(){win.close();}});},failure:function(f,a){f.owner.el.unmask();Ext.Msg.alert(_('Error'),a.result?a.result.message:_('No response from the server'));if(a.result&&a.result.errors){form.markInvalid(a.result.errors);}}});}}}],getFormFields:function(){var me=this,flds=['code','name'],displayField='name',model=Ext.define('MP.data.ImplicitModel-'+Ext.id(),{extend:'Ext.data.Model',fields:flds,idProperty:'code'}),lstore=Ext.create('Ext.data.Store',{model:model,autoLoad:true,proxy:{type:'ajax',url:'/data/languages',reader:{type:'json',root:'root',idProperty:'code',totalProperty:'count'}},listeners:{load:function(){var f;if(me.currentLanguage){f=me.down('form').form.getFields().get(1);f.suspendEvents();f.setValue(me.currentLanguage);f.resumeEvents();}else{f=me.down('form').form.getFields().get(0);f.suspendEvents();f.setValue(true);f.resumeEvents();}}}});lstore.implicitModel=true;return[{xtype:'checkbox',fieldLabel:_('Use browser setting'),name:'use_browser_setting',listeners:{change:function(cb,value){var f=me.down('form').form.getFields().get(1);f.suspendEvents();f.setValue(value?null:me.currentLanguage);f.resumeEvents();}}},{xtype:'combo',fieldLabel:_('Language'),name:'language',store:lstore,valueField:'code',displayField:'name',loadingText:_('Loading…'),selectOnFocus:true,allowBlank:true,anchor:'100%',listeners:{select:function(c,value){var f=me.down('form').form.getFields().get(0);f.suspendEvents();f.setValue(!value);f.resumeEvents();}}},{xtype:'container',height:'auto',margin:'20 15 5 15',style:{textAlign:'center'},html:[_('If you change this setting, it will be applied at your <b>next</b> login.')].join('')}];}});Ext.define('SoL.window.ChangePassword',{extend:'Ext.Window',uses:'Ext.form.Panel',title:_('Change your account password'),titleAlign:'center',width:400,autoHeight:true,closable:true,resizable:false,draggable:false,layout:'fit',border:false,modal:true,initComponent:function(){var me=this;Ext.apply(me,{items:[{xtype:'form',plain:true,frame:true,border:0,bodyPadding:5,url:'/auth/changePassword',items:me.getFormFields()}]});me.callParent();},buttons:['->',{text:_("Confirm"),type:"submit",formBind:true,handler:function(button){var win=button.up('window'),panel=win.down('form'),form=panel.getForm();if(form.isValid()){panel.getEl().mask(_("Changing password…"));form.submit({success:function(f,a){Ext.Msg.show({title:_('Change succeeded'),msg:_('Your account password has been successfully updated.'),icon:Ext.Msg.INFO,buttons:Ext.Msg.OK,fn:function(){win.close();}});},failure:function(f,a){f.owner.el.unmask();Ext.Msg.alert(_('Error'),a.result?a.result.message:_('No response from the server'));if(a.result&&a.result.errors){form.markInvalid(a.result.errors);}}});}}}],defaultFocus:'oldpassword',getFormFields:function(){return[{xtype:'textfield',fieldLabel:_('Old password'),name:'oldpassword',allowBlank:false,inputType:'password',minLength:6,anchor:'100%',selectOnFocus:true},{xtype:'textfield',fieldLabel:_('New password'),name:'newpassword',allowBlank:false,inputType:'password',minLength:6,anchor:'100%',selectOnFocus:true}];}});Ext.define('SoL.window.ResetPassword',{extend:'Ext.Window',uses:'Ext.form.Panel',title:_('Reset lost password'),titleAlign:'center',width:400,autoHeight:true,closable:false,resizable:false,draggable:false,layout:'fit',border:false,modal:true,initComponent:function(){var me=this;Ext.apply(me,{items:[{xtype:'form',plain:true,frame:true,border:0,bodyPadding:5,url:'/auth/resetPassword',baseParams:{token:window.location.hash.substr(16)},items:me.getFormFields()}]});me.callParent();},buttons:['->',{text:_("Change password"),type:"submit",formBind:true,handler:function(button){var win=button.up('window'),panel=win.down('form'),form=panel.getForm();if(form.isValid()){panel.getEl().mask(_("Changing password…"));form.submit({success:function(f,a){Ext.Msg.show({title:_('Password changed'),msg:_('Your password has been successfully changed, you will be redirected to the authentication panel.'),icon:Ext.Msg.INFO,buttons:Ext.Msg.OK,fn:function(){win.close();window.location.assign(a.result.location);}});},failure:function(f,a){f.owner.el.unmask();Ext.Msg.alert(_('Error'),a.result?a.result.message:_('No response from the server'));if(a.result&&a.result.errors){form.markInvalid(a.result.errors);}}});}}}],defaultFocus:'password',getFormFields:function(){return[{xtype:'textfield',fieldLabel:_('New password'),name:'password',allowBlank:false,inputType:'password',minLength:6,anchor:'100%',selectOnFocus:true}];}});Ext.define('SoL.window.Login',{extend:'MP.window.Login',uses:['Ext.form.field.VTypes'],width:450,initComponent:function(){var me=this;me.callParent(arguments);if(!Ext.form.field.VTypes.emailorusername){var username_rx=/^\w+$/;Ext.apply(Ext.form.field.VTypes,{emailorusername:function(val,field){return username_rx.test(val)||Ext.form.field.VTypes.email(val);},emailorusernameText:_('This field must be a valid email address'),emailorusernameMask:Ext.form.field.VTypes.emailMask});}
var version=me.getDockedItems('toolbar[dock="bottom"] > label')[0];if(__admin_email__){version.setText(Ext.String.format('<a href="{0}" target="_blank">{1}</a> &mdash; <a href="mailto:{2}?subject=SoL">{3}</a>',"https://gitlab.com/metapensiero/SoL/blob/master/CHANGES.rst",version.text,__admin_email__,'\uD83D\uDCE7 admin…'),false);}else{version.setText(Ext.String.format('<a href="{0}" target="_blank">{1}</a> &mdash; <a href="{2}" target="_blank">{3}</a>',"https://gitlab.com/metapensiero/SoL/blob/master/CHANGES.rst",version.text,"/static/manual/index.html",_('About…')),false);}
var tbitems=me.getDockedItems('toolbar[dock="bottom"]')[0];if(__signin__){tbitems.insert(2,{xtype:'button',text:_('Register…'),tooltip:_('Create a new account.'),action:'signin',formBind:false});}
if(__password_reset__){tbitems.insert(2,{xtype:'button',text:_('Lost password?'),tooltip:_('Request a reset of the password.'),action:'lostpassword',formBind:false});}},getFormFields:function(){var me=this,fields=me.callParent();fields[0].fieldLabel=_('Email address');fields[0].vtype='emailorusername';fields.unshift({xtype:'container',height:100,html:['<a href="/lit" data-qtip="',_('Go to the light HTML only interface…').replace(/"/g,'”'),'" target="_blank">','  <img src="/static/images/logo.png"','       style="margin-top: 15px; margin-left: 20px; float: left;">','</a>','<div style="margin-top: 25px; text-align: center;">','<b>Scarry On Line</b><br/><br/>',_('Carrom tournaments management'),'</div>'].join('')});return fields;}});Ext.define('SoL.window.LostPassword',{extend:'Ext.Window',uses:'Ext.form.Panel',title:_('Lost password'),titleAlign:'center',width:400,autoHeight:true,closable:true,resizable:false,draggable:false,layout:'fit',border:false,modal:true,initComponent:function(){var me=this;Ext.apply(me,{items:[{xtype:'form',plain:true,frame:true,border:0,bodyPadding:5,url:'/auth/lostPassword',items:me.getFormFields()}]});me.callParent();},buttons:['->',{text:_("Confirm"),type:"submit",formBind:true,handler:function(button){var win=button.up('window'),panel=win.down('form'),form=panel.getForm();if(form.isValid()){panel.getEl().mask(_("Requesting password reset…"));form.submit({headers:{'X-CSRF-Token':__csrf_token__},success:function(f,a){Ext.Msg.show({title:_('Request succeeded'),msg:_('An email has been sent to the given address, you should receive it shortly: please check your inbox and follow the link within two days to renew your password.'),icon:Ext.Msg.INFO,buttons:Ext.Msg.OK,fn:function(){win.close();}});},failure:function(f,a){f.owner.el.unmask();Ext.Msg.alert(_('Error'),a.result?a.result.message:_('No response from the server'));if(a.result&&a.result.errors){form.markInvalid(a.result.errors);}}});}}}],defaultFocus:'email',getFormFields:function(){return[{itemId:'email',xtype:'textfield',fieldLabel:_('Email'),name:'email',allowBlank:false,anchor:'100%',selectOnFocus:true,vtype:'email'}];}});Ext.define('SoL.window.Signin',{extend:'Ext.Window',uses:'Ext.form.Panel',title:_('Complete the form to request a new account'),titleAlign:'center',width:400,autoHeight:true,closable:true,resizable:false,draggable:false,layout:'fit',border:false,modal:true,initComponent:function(){var me=this;Ext.apply(me,{items:[{xtype:'form',plain:true,frame:true,border:0,bodyPadding:5,url:'/auth/signin',items:me.getFormFields()}]});me.callParent();},buttons:['->',{text:_("Register"),type:"submit",formBind:true,handler:function(button){var win=button.up('window'),panel=win.down('form'),form=panel.getForm();if(form.isValid()){panel.getEl().mask(_("Registration…"));form.submit({headers:{'X-CSRF-Token':__csrf_token__},success:function(f,a){Ext.Msg.show({title:_('Registration succeeded'),msg:_('An email has been sent to the given address, you should receive it shortly: please check your inbox and follow the link within two days to confirm the account.'),icon:Ext.Msg.INFO,buttons:Ext.Msg.OK,fn:function(){win.close();}});},failure:function(f,a){f.owner.el.unmask();Ext.Msg.alert(_('Error'),a.result?a.result.message:_('No response from the server'));if(a.result&&a.result.errors){form.markInvalid(a.result.errors);}}});}}}],defaultFocus:'email',getFormFields:function(){var flds=['code','name'],displayField='name',model=Ext.define('MP.data.ImplicitModel-'+Ext.id(),{extend:'Ext.data.Model',fields:flds,idProperty:'code'}),lstore=Ext.create('Ext.data.Store',{model:model,autoLoad:true,proxy:{type:'ajax',url:'/data/languages',reader:{type:'json',root:'root',idProperty:'code',totalProperty:'count'}}});lstore.implicitModel=true;return[{itemId:'email',xtype:'textfield',fieldLabel:_('Email'),name:'email',allowBlank:false,anchor:'100%',selectOnFocus:true,vtype:'email'},{xtype:'textfield',fieldLabel:_('Password'),name:'password',allowBlank:false,inputType:'password',minLength:6,anchor:'100%',selectOnFocus:true},{xtype:'textfield',fieldLabel:_('First name'),name:'firstname',allowBlank:false,anchor:'100%',selectOnFocus:true},{xtype:'textfield',fieldLabel:_('Last name'),name:'lastname',allowBlank:false,anchor:'100%',selectOnFocus:true},{xtype:'combo',fieldLabel:_('Language'),name:'language',store:lstore,valueField:'code',displayField:'name',loadingText:_('Loading…'),typeAhead:true,forceSelection:true,allowBlank:true,anchor:'100%',minChars:0},{xtype:'container',height:'auto',margin:'20 15 5 15',style:{textAlign:'center'},html:_('By registering, you <strong>agree</strong> with the <a href="/static/manual/en/privacy.html" target="_blank">SoL privacy policy</a>.')}];}});Ext.define('SoL.window.Help',{extend:'Ext.window.Window',uses:['SoL.component.IFrame'],layout:'fit',width:800,height:640,maximizable:true,iconCls:'help-icon',initComponent:function(){var me=this;me.items=[{xtype:'iframe'}];me.callParent();},onShow:function(){var me=this;var iframe=me.items.getAt(0);this.callParent();iframe.load(me.help_url);}});Ext.define('SoL.module.Players.Actions',{extend:'MP.action.StoreAware',uses:['Ext.Action','Ext.form.field.File','Ext.form.field.VTypes','MP.form.Panel','MP.window.Notification','SoL.window.Help'],statics:{EDIT_PLAYER_ACTION:'edit_player',SHOW_TOURNEYS_ACTION:'show_tourneys',SHOW_DUPLICATED_ACTION:'show_duplicates',SHOW_DISTRIBUTION_ACTION:'show_distribution',SHOW_LIT_PAGE_ACTION:'show_lit',SET_AGREED_PRIVACY_ACTION:'set_agreed_privacy'},initActions:function(){var me=this,ids=me.statics();me.callParent();me.editPlayer=me.addAction(new Ext.Action({itemId:ids.EDIT_PLAYER_ACTION,text:_('Modify'),tooltip:_('Edit selected player.'),iconCls:'edit-record-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0];me.showEditPlayerWindow(record);}}));me.showDuplicatedPlayers=me.addAction(new Ext.Action({itemId:ids.SHOW_DUPLICATED_ACTION,text:_('Duplicates'),tooltip:_('Show possibly duplicated players that should be merged together.'),iconCls:'dup-users-icon',needsCleanStore:true,handler:function(){var store=me.component.store,win=me.component.up();if(this.dups){store.proxy.url=me.component.dataURL;store.load();this.setText(_('Duplicates'));this.dups=false;win.setTitle(_('Players'));}else{var filterbar=me.component.findPlugin('filterbar');if(filterbar){filterbar.clearFilters();}
store.proxy.url=Ext.String.urlAppend(me.component.dataURL,'dups=1');store.load();this.setText(_('Show all'));this.dups=true;win.setTitle(_('Possibly duplicated players'));}}}));me.showTourneys=me.addAction(new Ext.Action({itemId:ids.SHOW_TOURNEYS_ACTION,text:_('Tourneys'),tooltip:_('Show tourneys played by the selected player.'),iconCls:'show-tourneys-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idplayer=record.get('idplayer'),player=SoL.module.Players.full_name(record),module=me.module.app.getModule('tourneys-win');module.createOrShowWindow('players',idplayer,player);}}));me.showDistribution=me.addAction(new Ext.Action({itemId:ids.SHOW_DISTRIBUTION_ACTION,text:_('Distribution'),tooltip:_('Show players distribution around the globe.'),iconCls:'players-distribution-icon',handler:function(){var desktop=me.module.app.getDesktop(),url='/svg/playersdist?'+Ext.Object.toQueryString({width:Math.floor(desktop.getWidth()*0.8),height:Math.floor(desktop.getHeight()*0.8)});window.open(url,"_blank");}}));me.showLitPage=me.addAction(new Ext.Action({itemId:ids.SHOW_LIT_PAGE_ACTION,text:_('Lit page'),tooltip:_('Show the corresponding Lit page.'),iconCls:'lit-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],guid=record.get('guid'),url='/lit/player/'+guid;window.open(url,"_blank");}}));me.setAgreedPrivacy=me.addAction(new Ext.Action({itemId:ids.SET_AGREED_PRIVACY_ACTION,text:_('Privacy'),tooltip:_('Make the selected players “discernible” in public views.'),iconCls:'agreed-privacy-icon',disabled:true,needsSelectedRow:true,handler:function(){var sels=me.component.getSelectionModel().getSelection(),currentuser=me.module.app.user,all_owned=true;if(!currentuser.is_admin){Ext.each(sels,function(record){if(record.get('idowner')!==null&&record.get('idowner')!==currentuser.user_id){all_owned=false;return false;}
return true;});}
if(all_owned){Ext.each(sels,function(record){record.set('agreedprivacy','A');});Ext.create("MP.window.Notification",{position:'t',width:260,title:_('Changes have been applied…'),html:_('Your changes have been applied <strong>locally</strong>.<br/><br/>To make them permanent you must click on the <blink>Save</blink> button.'),iconCls:'info-icon'}).show();}else{Ext.create("MP.window.Notification",{position:'br',width:260,title:_('Unauthorized'),html:_('At least one of the selected players does not belong to you, and thus cannot be modified, sorry!'),iconCls:'alert-icon'}).show();}}}));},attachActions:function(){var me=this,currentuser=me.module.app.user;me.callParent();var tbar=me.component.child('#ttoolbar');if(currentuser.is_playersmanager)
tbar.add(2,' ',me.editPlayer,me.showTourneys,me.showDuplicatedPlayers,me.showDistribution,me.setAgreedPrivacy);else
tbar.add(0,me.showTourneys,me.showDistribution);me.component.on({itemdblclick:function(){if(!me.editPlayer.isDisabled())
me.editPlayer.execute();}});me.component.store.on({add:function(store,records){var record=records[0];me.showEditPlayerWindow(record);}});},shouldDisableAction:function(act){var me=this,disable=me.component.shouldDisableAction(act),statics=me.statics(),currentuser=me.module.app.user;if(!disable&&!currentuser.is_admin){if(act.itemId==statics.EDIT_PLAYER_ACTION){if(!me.module.app.user.is_playersmanager)
disable=true;else{var record=me.component.getSelectionModel().getSelection()[0];if(record.get('idowner')!==null&&record.get('idowner')!==currentuser.user_id)
disable=true;}}}
return disable;},readImageAsDataURL:function(event,elt,form){var file=elt.files[0];if(file.type.split('/')[0]=='image'){var reader=new FileReader();form._portrait=file.name;reader.onload=function(e){var img=e.target.result;if(img.length>(512000*1.33)){Ext.MessageBox.alert(_('Error'),_('Image too big, max 512k allowed'));form._portrait=null;}else{form.down('image').setSrc(img);}};reader.onerror=function(){Ext.MessageBox.alert(_('Error'),_('Sorry, could not read image file')
+': '+reader.error);form._portrait=null;};reader.readAsDataURL(file);}else{Ext.MessageBox.alert(_('Error'),_('Only image files allowed'));}},deleteImage:function(form){form._portrait='';form.down('image').setSrc('');},showEditPlayerWindow:function(record){var me=this,desktop=me.module.app.getDesktop(),win=desktop.getWindow('edit-player-win');if(win){win.destroy();}
var metadata=me.module.config.metadata,size=desktop.getReasonableWindowSize(1000,420),editors=metadata.editors({'*':{editor:MP.form.Panel.getDefaultEditorSettingsFunction('100%')},firstname:{editor:{minLength:2}},lastname:{editor:{minLength:2}},nationality:{editor:{xtype:'flagscombo'}},Language:{editor:{queryMode:'local'}}}),secondcoleditors=[editors.Language,editors.nationality,editors.citizenship,editors.Club,editors.Federation,editors.Owner];if(me.module.app.user.is_admin||me.module.app.user.is_ownersadmin)
secondcoleditors.push(editors.ownersadmin);var form=Ext.create('MP.form.Panel',{autoScroll:true,fieldDefaults:{labelWidth:100,margin:'15 10 0 10'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',minHeight:245,flex:1,items:[editors.firstname,editors.lastname,editors.nickname,editors.sex,editors.birthdate,editors.email,editors.agreedprivacy]},{xtype:'container',layout:'anchor',minHeight:245,flex:1,items:secondcoleditors},{xtype:'container',style:'text-align: center;',minHeight:245,width:170,items:[{xtype:'image',margin:'50 10 0 10',border:1,style:{maxWidth:'150px',maxHeight:'150px',borderColor:'lightgray',borderStyle:'solid'}},{xtype:'filefield',name:'emblem',fieldLabel:'',labelWidth:0,buttonOnly:true,buttonText:_('Change portrait…'),style:'text-align: center;',listeners:{afterrender:function(fld){var el=fld.fileInputEl.dom;el.setAttribute('accept','image/*');},el:{change:{fn:function(event,elt){if(elt.files.length)
me.readImageAsDataURL(event,elt,form);}}}}},{xtype:'button',text:_('Delete portrait'),handler:function(){me.deleteImage(form);}}]}]}],buttons:[{text:_('Cancel'),handler:function(){if(record.phantom){record.store.deleteRecord(record);}
win.close();}},{text:_('Confirm'),formBind:true,handler:function(){if(form.isValid()){form.updateRecord(record);if(form._portrait!==undefined){record.set('portrait',form._portrait);record.modified['portrait']='';record.set('image',form.down('image').src);}
win.close();Ext.create("MP.window.Notification",{position:'t',width:260,title:_('Changes have been applied…'),html:_('Your changes have been applied <strong>locally</strong>.<br/><br/>To make them permanent you must click on the <blink>Save</blink> button.'),iconCls:'info-icon'}).show();}}}]});win=desktop.createWindow({id:'edit-player-win',title:_('Edit player'),iconCls:me.module.iconCls,width:size.width,height:size.height,modal:true,items:form,closable:false,minimizable:false,maximizable:false,resizable:false,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640);var wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/players.html#insert-and-edit'),title:_('Help on player insert/edit')});wh.show();}}]});form.loadRecord(record);if(!Ext.isEmpty(record.get('portrait'))||!Ext.isEmpty(record.get('image'))){var portrait=form.down('image');if(!Ext.isEmpty(record.get('image'))){portrait.setSrc(record.get('image'));}else{portrait.setSrc('/lit/portrait/'+record.get('portrait'));}}
win.show();}});Ext.define('SoL.module.Players',{extend:'MP.desktop.Module',requires:['MP.grid.Panel'],uses:['Ext.grid.plugin.DragDrop','SoL.form.field.FlagsCombo','SoL.module.Players.Actions','SoL.module.Players.MergePlugin','SoL.module.Users','SoL.window.Help'],statics:{full_name:function(player,html){var lastname=player.get('lastname'),firstname=player.get('firstname'),nickname=player.get('nickname'),format=function(fmt,data){return fmt.replace(/\{(\w+)\}/g,function(m,i){return data[i];});};if(nickname){var nnlower=nickname.toLowerCase(),fnlower=firstname.toLowerCase(),lnlower=lastname.toLowerCase();if(nnlower!=fnlower&&nnlower!=lnlower){nickname=format('“{nickname}”',{nickname:nickname});}else{nickname='';}}else{nickname='';}
if(html!==false){if(nickname!==''){return format(_('<b>{lastname}</b> {firstname} {nickname}'),{lastname:lastname,firstname:firstname,nickname:nickname});}else{return format(_('<b>{lastname}</b> {firstname}'),{lastname:lastname,firstname:firstname});}}else{if(nickname!==''){return format(_('{lastname} {firstname} {nickname}'),{lastname:lastname,firstname:firstname,nickname:nickname});}else{return format(_('{lastname} {firstname}'),{lastname:lastname,firstname:firstname});}}}},id:'players-win',iconCls:'players-icon',launcherText:function(){return _('Players');},launcherTooltip:function(){return _('<b>Players</b><br />Basic players management.');},config:{xtype:'editable-grid',pageSize:23,autoShowAllEditors:false,clicksToEdit:0,dataURL:'/data/players',saveChangesURL:'/bio/saveChanges',sorters:['lastname','firstname'],stripeRows:true,selType:'checkboxmodel',viewConfig:{plugins:{ptype:'mergeplayers'}}},getConfig:function(callback){var me=this;var cfg=me.config;if(!cfg.metadata){MP.data.MetaData.fetch(cfg.dataURL,me,function(metadata){var overrides={Owner:{filter:false},nationality:{renderer:SoL.form.field.FlagsCombo.renderer,filter:{type:'combo',xtype:'flagscombo',noOperatorPlugin:true,editable:true},editor:{xtype:'flagscombo'}}};var fields=metadata.fields(overrides);fields.push({name:'image',type:'string',sendBackToServer:true});Ext.apply(cfg,{metadata:metadata,fields:fields,columns:metadata.columns(overrides,false),idProperty:metadata.primary_key,totalProperty:metadata.count_slot,successProperty:metadata.success_slot,rootProperty:metadata.root_slot,plugins:[Ext.create('SoL.module.Players.Actions',{module:me}),Ext.create('SoL.module.Users.AssignOwnership',{module:me})]});callback(cfg);me.app.on('logout',function(){delete cfg.metadata;},me,{single:true});});}else{callback(cfg);}},createOrShowWindow:function(caller,id,description,isfederation){var me=this,config=me.config,desktop=me.app.getDesktop(),win=desktop.getWindow(me.id),currentuser=me.app.user;if(win){win.destroy();}
me.configure([me.getConfig],function(done){var size=desktop.getReasonableWindowSize(800,640,"SE"),filteredOn='';config=Ext.apply({selModel:{listeners:{selectionchange:function(model,records){var num=records.length;var seltext='';if(num>0){seltext=' ('+Ext.String.format(ngettext('{0} selected','{0} selected',num),num)+')';}
win.setTitle((me.windowTitle||me.getLauncherText())
+filteredOn+seltext);}}}},config);if(!currentuser.is_playersmanager)
config.noAddAndDelete=true;if(caller=='clubs'){if(isfederation){filteredOn=' ('+Ext.String.format(_('associated with {0}'),description)+')';Ext.apply(config,{newRecordData:{idfederation:id,Federation:description},stickyFilters:[{property:'idfederation',value:id,operator:'='}]});}else{filteredOn=' ('+Ext.String.format(_('members of {0}'),description)+')';Ext.apply(config,{newRecordData:{idclub:id,Club:description},stickyFilters:[{property:'idclub',value:id,operator:'='}]});}}else if(caller=='competitors'){if(id&&id.length>0){config.stickyFilters=[{id:'ids',property:"idplayer",value:id.join(','),operator:'<>'}];}
if(description){if(description.isPlugin){config.plugins=[description].concat(config.plugins);}else{config.buttons=description;}}}else if(caller=='users'){filteredOn=' ('+Ext.String.format(_('owned by {0}'),description)+')';config=Ext.apply({filters:[{property:'idowner',value:id,operator:'='}]},config);}
win=desktop.createWindow({id:me.id,title:(me.windowTitle||me.getLauncherText())+filteredOn,taskbuttonTooltip:me.getLauncherTooltip(),iconCls:me.iconCls,items:[config],x:size.x,y:size.y,width:size.width,height:size.height,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640);var wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/players.html'),title:_('Help on players management')});wh.show();}}]});var grid=win.child('editable-grid');grid.store.load({params:{start:0,limit:me.pageSize},callback:function(){win.on({show:done,single:true});win.show();}});if(currentuser.is_playersmanager){var da=grid.findActionById('delete');da.shouldBeDisabled=me.shouldDisableDeleteAction.bind(grid);}});},shouldDisableDeleteAction:function(){var grid=this,sm=grid.getSelectionModel(),currentuser=grid.up().up().app.user;if(sm.getCount()>0){var selrecs=sm.getSelection(),disable=false;for(var i=selrecs.length-1;i>=0;i--){var record=selrecs[i];if(!currentuser.is_admin&&record.get('idowner')!==null&&currentuser.user_id!==record.get('idowner')){disable=true;break;}}
return disable;}else{return true;}}});Ext.define('SoL.module.Players.MergePlugin',{extend:'Ext.grid.plugin.DragDrop',alias:'plugin.mergeplayers',uses:['Ext.view.DragZone','SoL.module.Players.MergeTarget'],ddGroup:'player',onViewRender:function(view){var me=this,scrollEl;if(me.enableDrag){if(me.containerScroll){scrollEl=view.getEl();}
me.dragZone=new Ext.view.DragZone({view:view,ddGroup:me.dragGroup||me.ddGroup,containerScroll:me.containerScroll,scrollEl:scrollEl,getDragText:function(){var count=this.dragData.records.length;var msg=ngettext('{0} player','{0} players',count);return Ext.String.format(msg,count);}});}
if(me.enableDrop){me.dropZone=new SoL.module.Players.MergeTarget({view:view,ddGroup:me.dropGroup||me.ddGroup});}}});Ext.define('SoL.module.Players.MergeTarget',{extend:'Ext.dd.DropTarget',uses:['MP.window.Notification'],constructor:function(config){var me=this;Ext.apply(me,config);me.callParent([me.view.el]);},_allowDrop:function(source,e,data){var me=this;if(!e.hasModifier()||data.records.length===0){return false;}
var node=e.getTarget(me.view.getItemSelector());if(!node){return false;}
var app=me.view.up().up().up().app,currentuser=app.user;if(!currentuser.is_admin){for(var i=data.records.length-1;i>=0;i--){if(currentuser.user_id!=data.records[i].get('idowner')){return false;}}}
var trec=me.view.getRecord(node),tid=trec.get('idplayer'),sids=[];Ext.each(data.records,function(r){sids.push(r.get('idplayer'));});if(sids.indexOf(tid)>=0){return false;}
return[trec,data.records];},notifyDrop:function(source,e,data){var me=this,r=me._allowDrop(source,e,data);if(r===false){return false;}
var tdesc=SoL.module.Players.full_name(r[0]),tid=r[0].get('idplayer'),sdescs=[],sids=[];Ext.each(data.records,function(p){sdescs.push(SoL.module.Players.full_name(p));sids.push(p.get('idplayer'));});var howmany=sids.length;Ext.MessageBox.confirm(_('Confirm players merge'),Ext.String.format(ngettext('Player {0} will be replaced by {1} everywhere, if possible. Do you confirm?','Players {0} will be replaced by {1} everywhere, if possible. Do you confirm?',howmany),Ext.toSentence(sdescs,_('and')),tdesc),function(response){if('yes'==response){Ext.create("MP.window.Notification",{position:'br',html:_('Merging selected players…'),title:_('Please wait'),iconCls:'waiting-icon'}).show();Ext.Ajax.request({url:'/bio/mergePlayers',params:{tid:tid,sids:sids},method:'POST',success:function(result){var res=Ext.decode(result.responseText);var success,msg;if(res){success=res.success;msg=res.message;}else{success=false;msg=_('Cannot decode JSON object');}
if(success){Ext.create("MP.window.Notification",{position:'br',iconCls:'done-icon',title:_('Done'),html:msg}).show();me.view.store.reload();}else{Ext.create("MP.window.Notification",{position:'br',iconCls:'alert-icon',title:_('Error'),html:msg}).show();}},failure:function(result){Ext.create("MP.window.Notification",{position:'br',iconCls:'alert-icon',title:_('Error'),html:result.statusText}).show();}});}});return true;},notifyOver:function(source,e,data){return this._allowDrop(source,e,data)===false?this.dropNotAllowed:this.dropAllowed;}});Ext.define('SoL.module.MyPlayers',{extend:'SoL.module.Players',id:'my-players-win',iconCls:'players-icon',launcherText:null,init:function(){var me=this,user=me.app.user;if(!me.config.orig_dataURL)me.config.orig_dataURL=me.config.dataURL;me.config.dataURL=Ext.String.urlAppend(me.config.orig_dataURL,'filter_by_idowner='+(user.is_admin?'NULL':user.user_id));me.windowTitle=Ext.String.format(_('Players managed by {0}'),user.fullname);me.callParent();}});var nonEmptyValueRE=/\S/;Ext.apply(Ext.form.field.VTypes,{nonempty:function(val,field){return nonEmptyValueRE.test(val);},nonemptyText:_('This field cannot be empty, must contain at least one non-space character')});Ext.define('SoL.module.Tourneys.Actions',{extend:'MP.action.StoreAware',uses:['Ext.Action','MP.form.Panel','MP.window.Notification'],statics:{EDIT_TOURNEY_ACTION:'edit_tourney',DOWNLOAD_TOURNEY_ACTION:'download_tourney',REPLAY_TOURNEY_ACTION:'duplicate_tourney',CREATE_KNOCKOUT_TOURNEY_ACTION:'create_knockout_tourney',SHOW_TOURNEY_ACTION:'show_tourney',SHOW_CHAMPIONSHIP_ACTION:'show_championship',MANAGE_COMPETITORS_ACTION:'manage_competitors',SHOW_LIT_PAGE_ACTION:'show_lit',PRINT_BOARDLABELS_ACTION:'print_boardlabels',PRINT_PLAYBILL_ACTION:'print_playbill'},initActions:function(){var me=this,ids=me.statics();me.callParent();me.editTourneyAction=me.addAction(new Ext.Action({itemId:ids.EDIT_TOURNEY_ACTION,text:_('Modify'),tooltip:_('Edit selected tourney.'),iconCls:'edit-record-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0];me.showEditTourneyWindow(record);}}));me.showTourneyAction=me.addAction(new Ext.Action({itemId:ids.SHOW_TOURNEY_ACTION,text:_('Details'),tooltip:_('Show details of this tourney.'),iconCls:'show-tourney-detail-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],module=me.module.app.getModule('tourney-win');module.createOrShowWindow(record);var desktop=me.module.app.getDesktop(),win=desktop.getWindow(me.module.id);if(win){win.destroy();}}}));me.showChampionshipAction=me.addAction(new Ext.Action({itemId:ids.SHOW_CHAMPIONSHIP_ACTION,text:_('Championship'),tooltip:_('Show the championship this tourney belongs.'),iconCls:'championships-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idchampionship=record.get('idchampionship'),module=me.module.app.getModule('championships-win');module.createOrShowWindow('tourneys',idchampionship);}}));me.manageTourneyCompetitorsAction=me.addAction(new Ext.Action({itemId:ids.MANAGE_COMPETITORS_ACTION,text:_('Competitors'),tooltip:_("Manage tourney competitors, allowing player substitutions, even after prize-giving.<br>Use with <b>caution</b> only when you <i>know what you're doing</i>!"),iconCls:'edit-user-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idtourney=record.get('idtourney'),tourney=record.get('description'),championship=record.get('Championship'),hasrating=!!record.get('idrating'),date=record.get('date'),ppt=record.get('PlayersPerTeam'),module=me.module.app.getModule('competitors-win');module.createOrShowWindow(idtourney,tourney,date,championship,ppt,hasrating);}}));me.duplicateTourneyAction=me.addAction(new Ext.Action({itemId:ids.REPLAY_TOURNEY_ACTION,text:_('Replay again'),tooltip:_('Duplicate selected tourney and its competitors on today.'),iconCls:'replay-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0];me.duplicateTourney(record);}}));me.createKnockoutTourneyAction=me.addAction(new Ext.Action({itemId:ids.CREATE_KNOCKOUT_TOURNEY_ACTION,text:_('Create knockout tourney'),tooltip:_('Create a knockout tourney from the selected one.'),iconCls:'replay-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0];me.createKnockoutTourney(record);}}));me.downloadTourneyAction=me.addAction(new Ext.Action({itemId:ids.DOWNLOAD_TOURNEY_ACTION,text:_('Download'),tooltip:_('Download this tourney data.'),iconCls:'download-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idtourney=record.get('idtourney'),url='/bio/dump?idtourney='+idtourney;window.open(url,"_blank");}}));me.showLitPageAction=me.addAction(new Ext.Action({itemId:ids.SHOW_LIT_PAGE_ACTION,text:_('Lit page'),tooltip:_('Show the corresponding Lit page.'),iconCls:'lit-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],guid=record.get('guid'),url='/lit/tourney/'+guid;window.open(url,"_blank");}}));me.printBoardLabelsAction=me.addAction(new Ext.Action({itemId:ids.PRINT_BOARDLABELS_ACTION,text:_('Board labels'),tooltip:_('Print board labels for this tourney, to allow self-insertion of matches results.'),iconCls:'print-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0];me.printBoardLabels(record);}}));me.printPlaybillAction=me.addAction(new Ext.Action({itemId:ids.PRINT_PLAYBILL_ACTION,text:_('Playbill'),tooltip:_('Print the tourney playbill with QRCode to reach its Lit page.'),iconCls:'print-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idtourney=record.get('idtourney'),url='/pdf/playbill/'+idtourney;window.open(url,'_blank');}}));},attachActions:function(){var me=this,args=[];me.callParent();var tbar=me.component.child('#ttoolbar');if(me.component.noAddAndDelete){args.push(0);}else{args.push(2);args.push(' ');}
args.push(me.editTourneyAction,me.showTourneyAction,me.manageTourneyCompetitorsAction,me.duplicateTourneyAction,me.showChampionshipAction);tbar.add.apply(tbar,args);me.component.on({itemdblclick:function(){if(!me.editTourneyAction.isDisabled())
me.editTourneyAction.execute();}});me.component.store.on({add:function(store,records){var record=records[0];me.showEditTourneyWindow(record);}});},shouldDisableAction:function(act){var me=this,disable=me.component.shouldDisableAction(act),statics=me.statics(),currentuser=me.module.app.user,record;if(!disable&&!currentuser.is_admin){if(act.itemId==statics.EDIT_TOURNEY_ACTION||act.itemId==statics.MANAGE_COMPETITORS_ACTION){record=me.component.getSelectionModel().getSelection()[0];if(record.get('idowner')!==null&&record.get('idowner')!==currentuser.user_id)
disable=true;}}
if(!disable&&act.itemId==statics.CREATE_KNOCKOUT_TOURNEY_ACTION){record=me.component.getSelectionModel().getSelection()[0];if(!record.get('prized')||record.get('system')=='knockout')
disable=true;}
return disable;},showEditTourneyWindow:function(record){var me=this,desktop=me.module.app.getDesktop(),win=desktop.getWindow('edit-tourney-win');if(win){win.destroy();}
var metadata=me.module.config.metadata,size=desktop.getReasonableWindowSize(800,600),editors=metadata.editors({'*':{editor:MP.form.Panel.getDefaultEditorSettingsFunction('100%')},description:{editor:{minLength:6}},Championship:{editor:{listeners:{beforequery:function(queryPlan){var store=queryPlan.combo.store;var idclub=me.module.idclub;if(idclub){store.addFilter({id:'currentclub',property:'idclub',value:idclub,operator:'='},false);}},select:function(combo,records){record.data['IDClub']=records[0].get('idclub');}}}},Rating:{editor:{queryCaching:false,listeners:{beforequery:function(queryPlan){var store=queryPlan.combo.store;var idclub=record.get('IDClub');if(idclub){store.addFilter({id:'currentclub',property:'idclub',value:"NULL,"+idclub,operator:'='},false);}}}}}}),form=Ext.create('MP.form.Panel',{autoScroll:true,fieldDefaults:{labelWidth:100,margin:'15 10 0 10'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',flex:1,items:[editors.date,editors.description,editors.Championship,editors.HostingClub,editors.location,editors.socialurl,editors.system,editors.matcheskind,editors.finals,editors.finalkind]},{xtype:'container',layout:'anchor',flex:1,items:[editors.duration,editors.prealarm,editors.couplings,editors.delaytoppairing,editors.delaycompatriotpairing,editors.phantomscore,editors.retirements,editors.Rating,editors.Owner]}]}],buttons:[{text:_('Cancel'),handler:function(){if(record.phantom){record.store.deleteRecord(record);}
win.close();}},{text:_('Confirm'),formBind:true,handler:function(){if(form.isValid()){form.updateRecord(record);win.close();Ext.create("MP.window.Notification",{position:'t',width:260,title:_('Changes have been applied…'),html:_('Your changes have been applied <strong>locally</strong>.<br/><br/>To make them permanent you must click on the <blink>Save</blink> button.'),iconCls:'info-icon'}).show();}}}]});win=desktop.createWindow({id:'edit-tourney-win',title:_('Edit tourney'),iconCls:me.module.iconCls,width:size.width,height:size.height,modal:true,items:form,closable:false,minimizable:false,maximizable:false,resizable:false,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640),wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/tourneys.html#insert-and-edit'),title:_('Help on tourney insert/edit')});wh.show();}}]});form.loadRecord(record);win.show();},duplicateTourney:function(record){var me=this,idtourney=record.get('idtourney');Ext.Msg.confirm(_('Confirm tourney duplication'),_('The selected tourney, with its competitors but not the matches, will be replicated on the current day. Do you confirm?'),function(response){if('yes'==response){Ext.create("MP.window.Notification",{position:'br',html:_('Replicating selected tourney…'),title:_('Please wait'),iconCls:'waiting-icon'}).show();Ext.Ajax.request({url:'/tourney/replayToday',params:{idtourney:idtourney},success:function(result){var res=Ext.decode(result.responseText),newid,store,prevOptions;if(res&&res.success){Ext.create("MP.window.Notification",{position:'br',iconCls:'done-icon',title:_('Done'),html:res.message}).show();newid=res.new_idtourney;store=me.component.store;prevOptions=Ext.apply({},store.lastOptions);store.reload({callback:function(records){for(var i=0;i<records.length;i++){if(records[i].getId()==newid){me.showEditTourneyWindow(records[i]);break;}}
store.lastOptions=prevOptions;}});}else{Ext.create("MP.window.Notification",{position:'br',iconCls:'alert-icon',title:_('Error'),html:res?res.message:_('Cannot decode JSON object')}).show();}},failure:function(result){Ext.create("MP.window.Notification",{position:'br',iconCls:'alert-icon',title:_('Error'),html:result.statusText}).show();}});}});},createKnockoutTourney:function(record){var me=this,win,form,winWidth=215,winHeight=110,top_players;var handler=function(){var frm=form.getForm();if(frm.isValid()){var ncompetitors=frm.getFields().items[0].getValue();win.destroy();Ext.create("MP.window.Notification",{position:'br',html:_('Replicating selected tourney…'),title:_('Please wait'),iconCls:'waiting-icon'}).show();Ext.Ajax.request({url:'/tourney/createKnockout',params:{idtourney:record.get('idtourney'),ncompetitors:ncompetitors},success:function(result){var res=Ext.decode(result.responseText),newid,store,prevOptions;if(res&&res.success){Ext.create("MP.window.Notification",{position:'br',iconCls:'done-icon',title:_('Done'),html:res.message}).show();newid=res.new_idtourney;store=me.component.store;prevOptions=Ext.apply({},store.lastOptions);store.reload({callback:function(records){for(var i=0;i<records.length;i++){if(records[i].getId()==newid){me.showEditTourneyWindow(records[i]);break;}}
store.lastOptions=prevOptions;}});}else{Ext.create("MP.window.Notification",{position:'br',iconCls:'alert-icon',title:_('Error'),html:res?res.message:_('Cannot decode JSON object')}).show();}},failure:function(result){Ext.create("MP.window.Notification",{position:'br',iconCls:'alert-icon',title:_('Error'),html:result.statusText}).show();}});}};var onKeyDown=function(field,event){if(event.keyCode===event.RETURN||event.keyCode===10){handler();}};var onSpinUp=function(field){var value=top_players,p2=Math.trunc(Math.log2(value));value=Math.pow(2,p2+1);top_players=value;field.setValue(value-1);};var onSpinDown=function(field){var value=top_players,p2=Math.trunc(Math.log2(value));value=Math.pow(2,p2-1);top_players=value;field.setValue(value+1);};var validator=function(value){value=parseInt(value,10);var p2=Math.log2(value);if(p2>0&&p2!=Math.trunc(p2)){return _("Must be a power-of-two, i.e. 2, 4, 8, 16...");}else{top_players=value;return true;}};var ncompetitors=record.get('Participants')/record.get('PlayersPerTeam'),maxcompetitors=Math.pow(2,Math.trunc(Math.log2(ncompetitors)));top_players=Math.min(16,maxcompetitors);form=new Ext.form.Panel({frame:true,bodyPadding:'10 10 0',defaults:{labelWidth:90,anchor:'100%'},items:[{xtype:'numberfield',itemId:'ncompetitors',allowBlank:false,allowDecimals:false,minValue:2,maxValue:maxcompetitors,value:top_players,validator:validator,enableKeyEvents:true,fieldLabel:_('Top competitors'),listeners:{keydown:onKeyDown,spinup:onSpinUp,spindown:onSpinDown}}],buttons:[{text:_('Cancel'),handler:function(){win.destroy();}},{text:_('Confirm'),formBind:true,handler:handler}]});win=me.module.app.getDesktop().createWindow({title:_('Create knockout tourney'),width:winWidth,height:winHeight,layout:'fit',minimizable:false,maximizable:false,items:[form],defaultFocus:'ncompetitors'});win.show();},printBoardLabels:function(record){var me=this,idtourney=record.get('idtourney'),current_competitors=record.get('Participants')/record.get('PlayersPerTeam'),url='/pdf/boardlabels/'+idtourney,win,form,winWidth=245,winHeight=110;var handler=function(){var frm=form.getForm();if(frm.isValid()){var flds=frm.getFields(),nboards=flds.items[0].getValue();url+='?nboards='+nboards;win.destroy();window.open(url,"_blank");}};var onKeyDown=function(field,event){if(event.keyCode===event.RETURN||event.keyCode===10){handler();}};form=new Ext.form.Panel({frame:true,bodyPadding:'10 10 0',defaults:{labelWidth:120,anchor:'100%'},items:[{xtype:'numberfield',itemId:'nboards',allowBlank:false,allowDecimals:false,minValue:1,value:Math.trunc(current_competitors/2)||1,enableKeyEvents:true,fieldLabel:_('Number of carromboards'),listeners:{keydown:onKeyDown,scope:me}}],buttons:[{text:_('Cancel'),handler:function(){win.destroy();}},{text:_('Confirm'),formBind:true,handler:handler}]});win=me.module.app.getDesktop().createWindow({title:_('Print carromboard labels'),width:winWidth,height:winHeight,layout:'fit',minimizable:false,maximizable:false,items:[form],defaultFocus:'nboards'});win.show();}});Ext.define('SoL.module.Tourneys',{extend:'MP.desktop.Module',requires:['MP.grid.Panel'],uses:['SoL.module.Tourneys.Actions','SoL.module.Users','SoL.window.Help'],statics:{dateToISO:function(date){var year=''+date.getFullYear(),month=''+(date.getMonth()+1),day=''+date.getDate();if(month.length<2){month='0'+month;}
if(day.length<2){day='0'+day;}
return year+'-'+month+'-'+day;}},id:'tourneys-win',iconCls:'tourneys-icon',launcherText:function(){return _('Tourneys');},launcherTooltip:function(){return _('<b>Tourneys</b><br />Basic tourneys management.');},config:{xtype:'editable-grid',pageSize:14,autoShowAllEditors:false,clicksToEdit:0,dataURL:'/data/tourneys',saveChangesURL:'/bio/saveChanges',sorters:[{property:'date',direction:'DESC'}],stripeRows:true,selModel:{mode:'MULTI'}},getConfig:function(callback){var me=this,cfg=me.config;if(!cfg.metadata){MP.data.MetaData.fetch(cfg.dataURL,me,function(metadata){var overrides={Owner:{filter:false}};Ext.apply(cfg,{metadata:metadata,fields:metadata.fields(overrides),columns:metadata.columns(overrides,false),idProperty:metadata.primary_key,totalProperty:metadata.count_slot,successProperty:metadata.success_slot,rootProperty:metadata.root_slot,plugins:[Ext.create('SoL.module.Tourneys.Actions',{module:me}),Ext.create('SoL.module.Users.AssignOwnership',{module:me})]});callback(cfg);me.app.on('logout',function(){delete cfg.metadata;},me,{single:true});});}else{callback(cfg);}},createOrShowWindow:function(caller,id,description,idclub,club,couplings,closed,idrating,rating){var me=this,config=me.config,desktop=me.app.getDesktop(),win=desktop.getWindow(me.id);if(win){win.destroy();}
me.idclub=idclub;me.configure([me.getConfig],function(done){var size=desktop.getReasonableWindowSize(920,421,"NE"),filteredOn;if(club){filteredOn=' ('+Ext.String.format(_('in championship {0}, organized by {1}'),description,club)+')';}else if(description){var explanation;switch(caller){case'championships':explanation=_('in championship');break;case'clubs':explanation=_('hosted by');break;case'players':explanation=_('played by');break;case'ratings':explanation=_('related with');break;case'users':explanation=_('owned by');break;default:explanation='';break;}
if(explanation!==''){explanation+=' ';}
filteredOn=' ('+explanation+description+')';}else{filteredOn='';}
config=Ext.apply({newRecordData:{date:new Date(),currentturn:0,rankedturn:0,prized:false,duration:45,prealarm:5,phantomscore:25,finals:0,delaytoppairing:1,delaycompatriotpairing:0,couplings:couplings||'serial',retirements:'none',system:'swiss',matcheskind:'simple'},filters:[{property:'date',value:SoL.module.Tourneys.dateToISO(new Date()),operator:'<='}]},config);if(caller=='championships'){Ext.apply(config.newRecordData,{idchampionship:id,Championship:description,idrating:idrating,Rating:rating});Ext.apply(config,{noAddAndDelete:closed,stickyFilters:[{property:'idchampionship',value:id,operator:'='}]});}else if(caller=='ratings'){Ext.apply(config.newRecordData,{idrating:id,Rating:description});Ext.apply(config,{stickyFilters:[{property:'idrating',value:id,operator:'='}]});}else if(caller=='players'){Ext.apply(config,{noAddAndDelete:true,extraParams:{idplayer:id}});}else if(caller=='users'){Ext.apply(config,{stickyFilters:[{property:'idowner',value:id,operator:'='}]});}else if(caller=='clubs'){Ext.apply(config,{stickyFilters:[{property:'idhostingclub',value:id,operator:'='}]});}
win=desktop.createWindow({id:me.id,title:(me.windowTitle||me.getLauncherText())+filteredOn,taskbuttonTooltip:me.getLauncherTooltip(),iconCls:me.iconCls,items:[config],x:size.x,y:size.y,width:size.width,height:size.height,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640);var wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/tourneys.html'),title:_('Help on tourneys management')});wh.show();}}]});var grid=win.child('editable-grid');grid.store.load({params:{start:0,limit:me.pageSize},callback:function(){win.on({show:done,single:true});win.show();}});var da=grid.findActionById('delete');if(da)
da.shouldBeDisabled=me.shouldDisableDeleteAction.bind(grid);});},shouldDisableDeleteAction:function(){var grid=this,sm=grid.getSelectionModel(),currentuser=grid.up().up().app.user;if(sm.getCount()>0){var selrecs=sm.getSelection(),disable=false;for(var i=selrecs.length-1;i>=0;i--){var record=selrecs[i];if(!currentuser.is_admin&&record.get('idowner')!==null&&currentuser.user_id!==record.get('idowner')){disable=true;break;}}
return disable;}else{return true;}}});Ext.define('SoL.module.MyTourneys',{extend:'SoL.module.Tourneys',id:'my-tourneys-win',iconCls:'tourneys-icon',launcherText:null,init:function(){var me=this,user=me.app.user;if(!me.config.orig_dataURL)me.config.orig_dataURL=me.config.dataURL;me.config.dataURL=Ext.String.urlAppend(me.config.orig_dataURL,'filter_by_idowner='+(user.is_admin?'NULL':user.user_id));me.windowTitle=Ext.String.format(_('Tourneys managed by {0}'),user.fullname);me.callParent();}});Ext.define('SoL.module.RatedPlayers.Actions',{extend:'MP.action.StoreAware',uses:['Ext.Action'],statics:{SHOW_CHART_ACTION:'show_chart',SHOW_RANKING_ACTION:'show_ranking'},initActions:function(){var me=this,ids=me.statics();me.callParent();me.showChart=me.addAction(new Ext.Action({itemId:ids.SHOW_CHART_ACTION,text:_('Chart'),tooltip:_('Show the rating chart of selected players.'),iconCls:'rating-chart-icon',needsSelectedRow:true,disabled:true,handler:function(){var idrating=me.module.idrating,sels=me.component.getSelectionModel().getSelection(),players=[],desktop=me.module.app.getDesktop();for(var i=0,l=sels.length;i<l;i++){var id=sels[i].get('idplayer');players.push(id);}
var url='/svg/ratingchart/'+idrating+'?'+Ext.Object.toQueryString({idplayer:players,width:Math.floor(desktop.getWidth()*0.8),height:Math.floor(desktop.getHeight()*0.8)});window.open(url,"_blank");}}));me.showRanking=me.addAction(new Ext.Action({itemId:ids.SHOW_RANKING_ACTION,text:_('Print'),tooltip:_('Print this rating ranking.'),iconCls:'print-icon',handler:function(){var idrating=me.module.idrating,url='/pdf/ratingranking/'+idrating;window.open(url,"_blank");}}));},attachActions:function(){var me=this;me.callParent();var tbar=me.component.child('#ttoolbar');tbar.add(2,' ',me.showChart,me.showRanking);}});Ext.define('SoL.module.RatedPlayers',{extend:'MP.desktop.Module',requires:['MP.grid.Panel'],uses:['SoL.module.RatedPlayers.Actions','SoL.window.Help'],id:'rated-players-win',iconCls:'rated-players-icon',launcherText:null,launcherTooltip:function(){return _('Players rates.');},config:{xtype:'basic-grid',pageSize:14,readOnly:true,dataURL:'/data/ratedPlayers',sorters:[{property:'rate',direction:'DESC'}],stripeRows:true,selType:'checkboxmodel'},getConfig:function(callback){var me=this,cfg=me.config;if(!cfg.metadata){MP.data.MetaData.fetch(cfg.dataURL,me,function(metadata){var overrides={nationality:{renderer:SoL.form.field.FlagsCombo.renderer}};Ext.apply(cfg,{metadata:metadata,fields:metadata.fields(overrides),columns:metadata.columns(overrides,false),idProperty:metadata.primary_key,totalProperty:metadata.count_slot,successProperty:metadata.success_slot,rootProperty:metadata.root_slot,plugins:[Ext.create('SoL.module.RatedPlayers.Actions',{module:me})]});callback(cfg);me.app.on('logout',function(){delete cfg.metadata;},me,{single:true});});}else{callback(cfg);}},createOrShowWindow:function(idrating,rating){var me=this,config=me.config,desktop=me.app.getDesktop(),win=desktop.getWindow(me.id);if(win){win.destroy();}
me.idrating=idrating;me.configure([me.getConfig],function(done){var size=desktop.getReasonableWindowSize(690,421,"SE");config=Ext.apply({stickyFilters:[{property:'idrating',value:idrating,operator:'='}]},config);win=desktop.createWindow({id:me.id,title:Ext.String.format(_('Players in rating “{0}”'),rating),taskbuttonTooltip:me.getLauncherTooltip(),iconCls:me.iconCls,items:[config],x:size.x,y:size.y,width:size.width,height:size.height,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640),wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/playersrates.html'),title:_('Help on rated players window')});wh.show();}}]});win.child('basic-grid').store.load({params:{start:0,limit:me.pageSize},callback:function(){win.on({show:done,single:true});win.show();}});});}});Ext.define('SoL.module.Championships.Actions',{extend:'MP.action.StoreAware',uses:['Ext.Action','MP.form.Panel','MP.window.Notification','SoL.window.Help'],statics:{EDIT_CHAMPIONSHIP_ACTION:'edit_championship',DOWNLOAD_TOURNEYS_ACTION:'download_tourneys',SHOW_TOURNEYS_ACTION:'show_tourneys',SHOW_CLUB_ACTION:'show_club',SHOW_RANKING_ACTION:'show_ranking',SHOW_LIT_PAGE_ACTION:'show_lit'},initActions:function(){var me=this,ids=me.statics();me.callParent();me.editChampionship=me.addAction(new Ext.Action({itemId:ids.EDIT_CHAMPIONSHIP_ACTION,text:_('Modify'),tooltip:_('Edit selected championship.'),iconCls:'edit-record-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0];me.showEditChampionshipWindow(record);}}));me.showTourneys=me.addAction(new Ext.Action({itemId:ids.SHOW_TOURNEYS_ACTION,text:_('Tourneys'),tooltip:_('Show tourneys of this championship.'),iconCls:'show-tourneys-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idchampionship=record.get('idchampionship'),championship=record.get('description'),couplings=record.get('couplings'),idclub=record.get('idclub'),club=record.get('Club'),idrating=record.get('idrating'),rating=record.get('Rating'),closed=record.get('closed'),module=me.module.app.getModule('tourneys-win');module.createOrShowWindow('championships',idchampionship,championship,idclub,club,couplings,closed,idrating,rating);}}));me.showClub=me.addAction(new Ext.Action({itemId:ids.SHOW_CLUB_ACTION,text:_('Club'),tooltip:_('Show the club this championship belongs.'),iconCls:'clubs-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idclub=record.get('idclub'),module=me.module.app.getModule('clubs-win');module.createOrShowWindow('championships',idclub);}}));me.downloadTourneys=me.addAction(new Ext.Action({itemId:ids.DOWNLOAD_TOURNEYS_ACTION,text:_('Download'),tooltip:_('Download this whole championship of tourneys data.'),iconCls:'download-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idchampionship=record.get('idchampionship'),url='/bio/dump?idchampionship='+idchampionship;window.open(url,"_blank");}}));me.showChampionshipRanking=me.addAction(new Ext.Action({itemId:ids.SHOW_RANKING_ACTION,text:_('Ranking'),tooltip:_('Print this championship ranking.'),iconCls:'print-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idchampionship=record.get('idchampionship'),url='/pdf/championshipranking/'+idchampionship;window.open(url,"_blank");}}));me.showLitPage=me.addAction(new Ext.Action({itemId:ids.SHOW_LIT_PAGE_ACTION,text:_('Lit page'),tooltip:_('Show the corresponding Lit page.'),iconCls:'lit-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],guid=record.get('guid'),url='/lit/championship/'+guid;window.open(url,"_blank");}}));},attachActions:function(){var me=this;me.callParent();var tbar=me.component.child('#ttoolbar');tbar.add(2,' ',me.editChampionship,me.showTourneys,me.showClub,me.downloadTourneys,me.showChampionshipRanking);me.component.on({itemdblclick:function(){if(!me.editChampionship.isDisabled())
me.editChampionship.execute();}});me.component.store.on({add:function(store,records){var record=records[0];me.showEditChampionshipWindow(record);}});},shouldDisableAction:function(act){var me=this,disable=me.component.shouldDisableAction(act),statics=me.statics(),currentuser=me.module.app.user;if(!disable&&!currentuser.is_admin){if(act.itemId==statics.EDIT_CHAMPIONSHIP_ACTION){var record=me.component.getSelectionModel().getSelection()[0];if(record.get('idowner')!==null&&record.get('idowner')!==currentuser.user_id)
disable=true;}}
return disable;},showEditChampionshipWindow:function(record){var me=this,desktop=me.module.app.getDesktop(),win=desktop.getWindow('edit-championship-win');if(win){win.destroy();}
var metadata=me.module.config.metadata,size=desktop.getReasonableWindowSize(800,430),editors=metadata.editors({'*':{editor:MP.form.Panel.getDefaultEditorSettingsFunction()},description:{editor:{minLength:6}},Previous:{editor:{listeners:{beforequery:function(queryPlan){var store=queryPlan.combo.store,clubf=form.getForm().findField(editors.Club.name),idclub;if(!Ext.isEmpty(clubf.lastSelection)){var iname=clubf.store.proxy.reader.idProperty,srec=clubf.lastSelection[0];idclub=srec.get(iname);}else{idclub=record.get('idclub');}
store.addFilter([{id:'currentclub',property:'idclub',value:idclub,operator:'='},{id:'currentchampionship',property:'idchampionship',value:record.get('idchampionship'),operator:'<>'}],false);delete queryPlan.combo.lastQuery;}}}},Rating:{editor:{queryCaching:false,listeners:{beforequery:function(queryPlan){var store=queryPlan.combo.store;var idclub=record.get('idclub');if(idclub){store.addFilter({id:'currentclub',property:'idclub',value:"NULL,"+idclub,operator:'='},false);}}}}}}),form=Ext.create('MP.form.Panel',{autoScroll:true,fieldDefaults:{labelWidth:150,margin:'15 10 0 10'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',flex:1,items:[editors.description,editors.Club,editors.playersperteam,editors.skipworstprizes,editors.trainingboards]},{xtype:'container',layout:'anchor',flex:1,items:[editors.Rating,editors.couplings,editors.prizes,editors.closed,editors.Previous,editors.Owner]}]}],buttons:[{text:_('Cancel'),handler:function(){if(record.phantom){record.store.deleteRecord(record);}
win.close();}},{text:_('Confirm'),formBind:true,handler:function(){if(form.isValid()){form.updateRecord(record);win.close();Ext.create("MP.window.Notification",{position:'t',width:260,title:_('Changes have been applied…'),html:_('Your changes have been applied <strong>locally</strong>.<br/><br/>To make them permanent you must click on the <blink>Save</blink> button.'),iconCls:'info-icon'}).show();}}}]});win=desktop.createWindow({id:'edit-championship-win',title:_('Edit championship'),iconCls:me.module.iconCls,width:size.width,height:size.height,modal:true,items:form,closable:false,minimizable:false,maximizable:false,resizable:false,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640),wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/championships.html#insert-and-edit'),title:_('Help on championship insert/edit')});wh.show();}}]});form.loadRecord(record);win.show();}});Ext.define('SoL.module.Championships',{extend:'MP.desktop.Module',requires:['MP.grid.Panel'],uses:['SoL.module.Championships.Actions','SoL.module.Users','SoL.window.Help'],id:'championships-win',iconCls:'championships-icon',launcherText:function(){return _('Championships');},launcherTooltip:function(){return _('<b>Championships</b><br />Basic championships management.');},config:{xtype:'editable-grid',pageSize:14,autoShowAllEditors:false,clicksToEdit:0,dataURL:'/data/championships',saveChangesURL:'/bio/saveChanges',sorters:['closed','description'],stripeRows:true,selModel:{mode:'MULTI'}},getConfig:function(callback){var me=this,cfg=me.config;if(!cfg.metadata){MP.data.MetaData.fetch(cfg.dataURL,me,function(metadata){var overrides={Owner:{filter:false}};Ext.apply(cfg,{metadata:metadata,fields:metadata.fields(overrides),columns:metadata.columns(overrides,false),idProperty:metadata.primary_key,totalProperty:metadata.count_slot,successProperty:metadata.success_slot,rootProperty:metadata.root_slot,plugins:[Ext.create('SoL.module.Championships.Actions',{module:me}),Ext.create('SoL.module.Users.AssignOwnership',{module:me}),]});callback(cfg);me.app.on('logout',function(){delete cfg.metadata;},me,{single:true});});}else{callback(cfg);}},createOrShowWindow:function(caller,id,description,prizes,couplings,idrating,rating){var me=this,config=me.config,desktop=me.app.getDesktop(),win=desktop.getWindow(me.id);if(win){win.destroy();}
me.configure([me.getConfig],function(done){var size=desktop.getReasonableWindowSize(740,421,"SW"),filteredOn='';config=Ext.apply({newRecordData:{prizes:prizes||'fixed',couplings:couplings||'serial',skipworstprizes:0,playersperteam:1,closed:false}},config);if(caller=='clubs'){filteredOn=' ('+Ext.String.format(_('organized by {0}'),description)+')';config.newRecordData.idclub=id;config.newRecordData.Club=description;config.newRecordData.idrating=idrating;config.newRecordData.Rating=rating;config.stickyFilters=[{property:'idclub',value:id,operator:'='}];}else if(caller=='tourneys'){config.filters=[{property:'idchampionship',value:id,operator:'='}];}else if(caller=='users'){filteredOn=' ('+Ext.String.format(_('owned by {0}'),description)+')';config.filters=[{property:'idowner',value:id,operator:'='}];}
win=desktop.createWindow({id:me.id,title:(me.windowTitle||me.getLauncherText())+filteredOn,taskbuttonTooltip:me.getLauncherTooltip(),iconCls:me.iconCls,items:[config],x:size.x,y:size.y,width:size.width,height:size.height,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640),wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/championships.html'),title:_('Help on championships management')});wh.show();}}]});var grid=win.child('editable-grid');grid.store.load({params:{start:0,limit:me.pageSize},callback:function(){win.on({show:done,single:true});win.show();}});var da=grid.findActionById('delete');da.shouldBeDisabled=me.shouldDisableDeleteAction.bind(grid);});},shouldDisableDeleteAction:function(){var grid=this,sm=grid.getSelectionModel(),currentuser=grid.up().up().app.user;if(sm.getCount()>0){var selrecs=sm.getSelection(),disable=false;for(var i=selrecs.length-1;i>=0;i--){var record=selrecs[i];if(record.get('Tourneys')>0||(!currentuser.is_admin&&record.get('idowner')!==null&&currentuser.user_id!==record.get('idowner'))){disable=true;break;}}
return disable;}else{return true;}}});Ext.define('SoL.module.MyChampionships',{extend:'SoL.module.Championships',id:'my-championships-win',iconCls:'championships-icon',launcherText:null,init:function(){var me=this,user=me.app.user;if(!me.config.orig_dataURL)me.config.orig_dataURL=me.config.dataURL;me.config.dataURL=Ext.String.urlAppend(me.config.orig_dataURL,'filter_by_idowner='+(user.is_admin?'NULL':user.user_id));me.windowTitle=Ext.String.format(_('Championships managed by {0}'),user.fullname);me.callParent();}});Ext.define('SoL.module.Clubs.Actions',{extend:'MP.action.StoreAware',uses:['Ext.Action','Ext.form.field.File','MP.form.Panel','MP.window.Notification','SoL.window.Help'],statics:{EDIT_CLUB_ACTION:'edit_club',DOWNLOAD_TOURNEYS_ACTION:'download_tourneys',SHOW_CHAMPIONSHIPS_ACTION:'show_championships',SHOW_MEMBERS_ACTION:'show_members',SHOW_ASSOCIATES_ACTION:'show_associates',SHOW_HOSTED_TOURNEYS_ACTION:'show_hosted_tourneys',SHOW_USERS_ACTION:'show_users',SHOW_LIT_PAGE_ACTION:'show_lit'},initActions:function(){var me=this;var ids=me.statics();me.callParent();me.editClub=me.addAction(new Ext.Action({itemId:ids.EDIT_CLUB_ACTION,text:_('Modify'),tooltip:_('Edit selected club.'),iconCls:'edit-record-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0];me.showEditClubWindow(record);}}));me.showChampionships=me.addAction(new Ext.Action({itemId:ids.SHOW_CHAMPIONSHIPS_ACTION,text:_('Championships'),tooltip:_('Show championships organized by this club.'),iconCls:'championships-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idclub=record.get('idclub'),club=record.get('description'),prizes=record.get('prizes'),couplings=record.get('couplings'),idrating=record.get('idrating'),rating=record.get('Rating'),module=me.module.app.getModule('championships-win');module.createOrShowWindow('clubs',idclub,club,prizes,couplings,idrating,rating);}}));me.showMembers=me.addAction(new Ext.Action({itemId:ids.SHOW_MEMBERS_ACTION,text:_('Members'),tooltip:_('Show players members of this club.'),iconCls:'players-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idclub=record.get('idclub'),club=record.get('description'),module=me.module.app.getModule('players-win');module.createOrShowWindow('clubs',idclub,club);}}));me.showAssociates=me.addAction(new Ext.Action({itemId:ids.SHOW_ASSOCIATES_ACTION,text:_('Associates'),tooltip:_('Show players associated with this federation.'),iconCls:'players-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idclub=record.get('idclub'),club=record.get('description'),module=me.module.app.getModule('players-win');module.createOrShowWindow('clubs',idclub,club,true);}}));me.downloadTourneys=me.addAction(new Ext.Action({itemId:ids.DOWNLOAD_TOURNEYS_ACTION,text:_('Download'),tooltip:_('Download data of all the tourneys in every championship organized by this club.'),iconCls:'download-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idclub=record.get('idclub'),url='/bio/dump?idclub='+idclub;window.open(url,"_blank");}}));me.showLitPage=me.addAction(new Ext.Action({itemId:ids.SHOW_LIT_PAGE_ACTION,text:_('Lit page'),tooltip:_('Show the corresponding Lit page.'),iconCls:'lit-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],guid=record.get('guid'),url='/lit/club/'+guid;window.open(url,"_blank");}}));var show_users=new Ext.Action({itemId:ids.SHOW_USERS_ACTION,text:_('Users'),tooltip:_('Show users associated to this club.'),iconCls:'users-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idclub=record.get('idclub'),club=record.get('description'),module=me.module.app.getModule('clubusers-win');module.createOrShowWindow(idclub,club);}});show_users.isDisabled=function(){var record=me.component.getSelectionModel().getSelection()[0],currentuser=me.module.app.user;return(!currentuser.is_admin&&record.get('idowner')!==null&&record.get('idowner')!==currentuser.user_id);};me.showUsers=me.addAction(show_users);me.showHostedTourneys=me.addAction(new Ext.Action({itemId:ids.SHOW_HOSTED_TOURNEYS_ACTION,text:_('Tourneys'),tooltip:_('Show tourneys hosted by this club.'),iconCls:'tourneys-icon',disabled:true,needsOneSelectedRow:true,needsCleanStore:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],idclub=record.get('idclub'),club=record.get('description'),module=me.module.app.getModule('tourneys-win');module.createOrShowWindow('clubs',idclub,club);}}));},attachActions:function(){var me=this;me.callParent();var tbar=me.component.child('#ttoolbar');tbar.add(2,' ',me.editClub,me.showChampionships,me.showHostedTourneys,{text:_('Players'),iconCls:'players-icon',menu:{items:[me.showMembers,me.showAssociates]}},me.downloadTourneys);me.component.on({itemdblclick:function(){if(!me.editClub.isDisabled())
me.editClub.execute();}});me.component.store.on({add:function(store,records){var record=records[0];me.showEditClubWindow(record);}});},shouldDisableAction:function(act){var me=this,disable=me.component.shouldDisableAction(act),statics=me.statics(),currentuser=me.module.app.user;if(!disable){var record=me.component.getSelectionModel().getSelection()[0];switch(act.itemId){case statics.EDIT_CLUB_ACTION:case statics.SHOW_USERS_ACTION:if(!currentuser.is_admin&&record.get('idowner')!==null&&record.get('idowner')!==currentuser.user_id)
disable=true;break;case statics.SHOW_ASSOCIATES_ACTION:if(!record.get('isfederation'))
disable=true;break;default:break;}}
return disable;},readImageAsDataURL:function(event,elt,form){var file=elt.files[0];if(file.type.split('/')[0]=='image'){var reader=new FileReader();form._emblem=file.name;reader.onload=function(e){var img=e.target.result;if(img.length>(512000*1.33)){Ext.MessageBox.alert(_('Error'),_('Image too big, max 512k allowed'));form._emblem=null;}else{form.down('image').setSrc(img);}};reader.onerror=function(){Ext.MessageBox.alert(_('Error'),_('Sorry, could not read image file')
+': '+reader.error);form._emblem=null;};reader.readAsDataURL(file);}else{Ext.MessageBox.alert(_('Error'),_('Only image files allowed'));}},deleteImage:function(form){form._emblem='';form.down('image').setSrc('');},showEditClubWindow:function(record){var me=this,desktop=me.module.app.getDesktop(),win=desktop.getWindow('edit-club-win');if(win){win.destroy();}
var metadata=me.module.config.metadata,size=desktop.getReasonableWindowSize(1000,310),editors=metadata.editors({'*':{editor:MP.form.Panel.getDefaultEditorSettingsFunction('100%')},description:{editor:{minLength:6}},nationality:{editor:{xtype:'flagscombo'}},Rating:{editor:{listeners:{beforequery:function(queryPlan){var store=queryPlan.combo.store;var idclub=record.get('idclub');if(idclub){store.addFilter({id:'currentclub',property:'idclub',value:"NULL,"+idclub,operator:'='},false);}}}}}}),form=Ext.create('MP.form.Panel',{autoScroll:true,fieldDefaults:{labelWidth:100,margin:'15 10 0 10'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:'anchor',minHeight:245,flex:1,items:[editors.description,editors.siteurl,editors.email,editors.nationality,editors.Rating]},{xtype:'container',layout:'anchor',minHeight:245,flex:1,items:[editors.isfederation,editors.couplings,editors.prizes,editors.Owner]},{xtype:'container',style:'text-align: center;',minHeight:245,width:170,items:[{xtype:'image',margin:'10 10 0 10',border:1,style:{maxWidth:'150px',maxHeight:'150px',borderColor:'lightgray',borderStyle:'solid'}},{xtype:'filefield',name:'emblem',fieldLabel:'',labelWidth:0,buttonOnly:true,buttonText:_('Change emblem…'),style:'text-align: center;',listeners:{afterrender:function(fld){var el=fld.fileInputEl.dom;el.setAttribute('accept','image/*');},el:{change:{fn:function(event,elt){if(elt.files.length)
me.readImageAsDataURL(event,elt,form);}}}}},{xtype:'button',text:_('Delete emblem'),handler:function(){me.deleteImage(form);}}]}]}],buttons:[{text:_('Cancel'),handler:function(){if(record.phantom){record.store.deleteRecord(record);}
win.close();}},{text:_('Confirm'),formBind:true,handler:function(){if(form.isValid()){form.updateRecord(record);if(form._emblem!==undefined){record.set('emblem',form._emblem);record.modified['emblem']='';record.set('image',form.down('image').src);}
win.close();Ext.create("MP.window.Notification",{position:'t',width:260,title:_('Changes have been applied…'),html:_('Your changes have been applied <strong>locally</strong>.<br/><br/>To make them permanent you must click on the <blink>Save</blink> button.'),iconCls:'info-icon'}).show();}}}]});win=desktop.createWindow({id:'edit-club-win',title:_('Edit club'),iconCls:me.module.iconCls,width:size.width,height:size.height,modal:true,items:form,closable:false,minimizable:false,maximizable:false,resizable:false,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640),wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/clubs.html#insert-and-edit'),title:_('Help on club insert/edit')});wh.show();}}]});form.loadRecord(record);if(!Ext.isEmpty(record.get('emblem'))||!Ext.isEmpty(record.get('image'))){var emblem=form.down('image');if(!Ext.isEmpty(record.get('image'))){emblem.setSrc(record.get('image'));}else{emblem.setSrc('/lit/emblem/'+record.get('emblem'));}}
win.show();}});Ext.define('SoL.module.Clubs',{extend:'MP.desktop.Module',requires:['MP.grid.Panel'],uses:['SoL.module.Clubs.Actions','SoL.module.ClubUsers','SoL.module.Users','SoL.form.field.FlagsCombo','SoL.window.Help'],id:'clubs-win',iconCls:'clubs-icon',launcherText:function(){return _('Clubs');},launcherTooltip:function(){return _('<b>Clubs</b><br />Basic clubs management.');},config:{xtype:'editable-grid',pageSize:14,autoShowAllEditors:false,clicksToEdit:0,dataURL:'/data/clubs',saveChangesURL:'/bio/saveChanges',sorters:['description'],stripeRows:true,selModel:{mode:'MULTI'}},getConfig:function(callback){var me=this,cfg=me.config;if(!cfg.metadata){MP.data.MetaData.fetch(cfg.dataURL,me,function(metadata){var overrides={Owner:{filter:false},nationality:{renderer:SoL.form.field.FlagsCombo.renderer,filter:{type:'combo',xtype:'flagscombo',noOperatorPlugin:true,editable:true},editor:{xtype:'flagscombo'}}},fields=metadata.fields(overrides);fields.push({name:'image',type:'string',sendBackToServer:true});Ext.apply(cfg,{metadata:metadata,fields:fields,columns:metadata.columns(overrides,false),idProperty:metadata.primary_key,totalProperty:metadata.count_slot,successProperty:metadata.success_slot,rootProperty:metadata.root_slot,plugins:[Ext.create('SoL.module.Clubs.Actions',{module:me}),Ext.create('SoL.module.Users.AssignOwnership',{module:me})]});callback(cfg);me.app.on('logout',function(){delete cfg.metadata;},me,{single:true});});}else{callback(cfg);}},createOrShowWindow:function(caller,id,description){var me=this,config=me.config,desktop=me.app.getDesktop(),win=desktop.getWindow(me.id);if(win){win.destroy();}
me.configure([me.getConfig],function(done){var size=desktop.getReasonableWindowSize(770,447,"NW"),filteredOn='';if(caller=='championships'){config=Ext.apply({filters:[{property:'idclub',value:id,operator:'='}]},config);}else if(caller=='users'){filteredOn=' ('+Ext.String.format(_('owned by {0}'),description)+')';config=Ext.apply({filters:[{property:'idowner',value:id,operator:'='}]},config);}
win=desktop.createWindow({id:me.id,title:(me.windowTitle||me.getLauncherText())+filteredOn,taskbuttonTooltip:me.getLauncherTooltip(),iconCls:me.iconCls,items:[config],x:size.x,y:size.y,width:size.width,height:size.height,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640);var wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/clubs.html'),title:_('Help on clubs management')});wh.show();}}]});var grid=win.child('editable-grid');grid.store.load({params:{start:0,limit:me.pageSize},callback:function(){win.on({show:done,single:true});win.show();}});var da=grid.findActionById('delete');da.shouldBeDisabled=me.shouldDisableDeleteAction.bind(grid);});},shouldDisableDeleteAction:function(){var grid=this,sm=grid.getSelectionModel(),currentuser=grid.up().up().app.user;if(sm.getCount()>0){var selrecs=sm.getSelection(),disable=false;for(var i=selrecs.length-1;i>=0;i--){var record=selrecs[i];if(record.get('Championships')>0||(!currentuser.is_admin&&record.get('idowner')!==null&&currentuser.user_id!==record.get('idowner'))){disable=true;break;}}
return disable;}else{return true;}}});Ext.define('SoL.module.MyClubs',{extend:'SoL.module.Clubs',id:'my-clubs-win',iconCls:'clubs-icon',launcherText:null,init:function(){var me=this,user=me.app.user;if(!me.config.orig_dataURL)me.config.orig_dataURL=me.config.dataURL;me.config.dataURL=Ext.String.urlAppend(me.config.orig_dataURL,'filter_by_idowner='+(user.is_admin?'NULL':user.user_id));me.windowTitle=Ext.String.format(_('Clubs managed by {0}'),user.fullname);me.callParent();}});Ext.define('SoL.module.Users.AssignOwnership',{extend:'MP.action.StoreAware',uses:['Ext.Action','MP.form.Panel','MP.window.Notification'],statics:{ASSIGN_OWNERSHIP_ACTION:'assign_ownership'},initActions:function(){var me=this;var ids=me.statics();me.callParent();me.assignOwnershipAction=me.addAction(new Ext.Action({itemId:ids.ASSIGN_OWNERSHIP_ACTION,text:_('Assign'),tooltip:_('Assign ownership of selected records.'),iconCls:'owner-icon',disabled:true,needsSelectedRow:true,handler:function(){me.assignOwnership();}}));},attachActions:function(){var me=this;me.callParent();if(me.module.app.user.is_admin||me.module.app.user.is_ownersadmin){var tbar=me.component.child('#ttoolbar');tbar.add(tbar.items.length-3,me.assignOwnershipAction);}},assignOwnership:function(){var me=this,desktop=me.module.app.getDesktop(),win,winWidth=390,winHeight=110,model=Ext.define('MP.data.ImplicitModel-'+Ext.id(),{extend:'Ext.data.Model',fields:['iduser','Fullname'],idProperty:'iduser'}),lstore=Ext.create('Ext.data.Store',{model:model,pageSize:999,autoLoad:false,remoteFilter:true,proxy:{type:'ajax',url:'/data/owners',filterParam:'filters',reader:{type:'json',root:'root',idProperty:'iduser'}}});lstore.implicitModel=true;var form=new Ext.form.Panel({frame:true,bodyPadding:'10 10 0',defaults:{labelWidth:90,anchor:'100%'},items:[{xtype:'combo',store:lstore,valueField:'iduser',displayField:'Fullname',buttonText:_('Browse'),emptyText:_('Select responsible'),allowBlank:false,triggerAction:'all',typeAhead:true,forceSelection:true,fieldLabel:_('Owner')}],buttons:[{text:_('Cancel'),handler:function(){win.destroy();}},{text:_('Confirm'),formBind:true,handler:function(){var frm=form.getForm();if(frm.isValid()){var combo=frm.getFields().getAt(0),sels=me.component.getSelectionModel().getSelection();Ext.each(sels,function(record){record.set('idowner',combo.value);record.set('Owner',combo.getRawValue());});win.destroy();}}}]});win=desktop.createWindow({id:me.id,title:_('Assign ownership'),iconCls:'upload-icon',width:winWidth,height:winHeight,layout:'fit',minimizable:false,maximizable:false,modal:true,items:[form]});win.show();}});Ext.define('SoL.module.Users.Actions',{extend:'MP.action.StoreAware',uses:['Ext.Action','MP.form.Panel','MP.window.Notification','SoL.module.Players','SoL.window.Help'],statics:{EDIT_USER_ACTION:'edit_user',SHOW_OWNED_CLUBS:'show_owned_clubs',SHOW_OWNED_CHAMPIONSHIPS:'show_owned_championships',SHOW_OWNED_PLAYERS:'show_owned_players',SHOW_OWNED_RATINGS:'show_owned_ratings',SHOW_OWNED_TOURNEYS:'show_owned_tourneys'},initActions:function(){var me=this;var ids=me.statics();me.callParent();me.editUser=me.addAction(new Ext.Action({itemId:ids.EDIT_USER_ACTION,text:_('Modify'),tooltip:_('Edit selected user.'),iconCls:'edit-record-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0];me.showEditUserWindow(record);}}));me.showOwnedClubs=me.addAction(new Ext.Action({itemId:ids.SHOW_OWNED_CLUBS,text:_('Clubs'),tooltip:_('Show clubs owned by the selected user.'),iconCls:'clubs-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],iduser=record.get('iduser'),user=SoL.module.Players.full_name(record),module=me.module.app.getModule('clubs-win');module.createOrShowWindow('users',iduser,user);}}));me.showOwnedChampionships=me.addAction(new Ext.Action({itemId:ids.SHOW_OWNED_CHAMPIONSHIPS,text:_('Championships'),tooltip:_('Show championships owned by the selected user.'),iconCls:'championships-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],iduser=record.get('iduser'),user=SoL.module.Players.full_name(record),module=me.module.app.getModule('championships-win');module.createOrShowWindow('users',iduser,user);}}));me.showOwnedPlayers=me.addAction(new Ext.Action({itemId:ids.SHOW_OWNED_PLAYERS,text:_('Players'),tooltip:_('Show players owned by the selected user.'),iconCls:'players-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],iduser=record.get('iduser'),user=SoL.module.Players.full_name(record),module=me.module.app.getModule('players-win');module.createOrShowWindow('users',iduser,user);}}));me.showOwnedRatings=me.addAction(new Ext.Action({itemId:ids.SHOW_OWNED_RATINGS,text:_('Ratings'),tooltip:_('Show ratings owned by the selected user.'),iconCls:'ratings-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],iduser=record.get('iduser'),user=SoL.module.Players.full_name(record),module=me.module.app.getModule('ratings-win');module.createOrShowWindow('users',iduser,user);}}));me.showOwnedTourneys=me.addAction(new Ext.Action({itemId:ids.SHOW_OWNED_TOURNEYS,text:_('Tourneys'),tooltip:_('Show tourneys owned by the selected user.'),iconCls:'tourneys-icon',disabled:true,needsOneSelectedRow:true,handler:function(){var record=me.component.getSelectionModel().getSelection()[0],iduser=record.get('iduser'),user=SoL.module.Players.full_name(record),module=me.module.app.getModule('tourneys-win');module.createOrShowWindow('users',iduser,user);}}));},attachActions:function(){var me=this;me.callParent();var tbar=me.component.child('#ttoolbar');tbar.add(2,' ',me.editUser,me.showOwnedClubs,me.showOwnedChampionships,me.showOwnedPlayers,me.showOwnedRatings,me.showOwnedTourneys);me.component.on({itemdblclick:function(){if(!me.editUser.isDisabled())
me.editUser.execute();}});me.component.store.on({add:function(store,records){var record=records[0];me.showEditUserWindow(record);}});},shouldDisableAction:function(act){var me=this,disable=me.component.shouldDisableAction(act),statics=me.statics(),currentuser=me.module.app.user;if(!disable){switch(act.itemId){case statics.EDIT_USER_ACTION:if(!currentuser.is_admin)
disable=true;break;default:break;}}
return disable;},showEditUserWindow:function(record){var me=this,desktop=me.module.app.getDesktop(),win=desktop.getWindow('edit-user-win');if(win){win.destroy();}
var metadata=me.module.config.metadata,size=desktop.getReasonableWindowSize(600,510),editors=metadata.editors({'*':{editor:MP.form.Panel.getDefaultEditorSettingsFunction('100%')},Language:{editor:{queryMode:'local'}},password:{editor:{minLength:6}}}),form=Ext.create('MP.form.Panel',{autoScroll:true,fieldDefaults:{labelWidth:100,margin:'15 10 0 10'},items:[{xtype:'container',layout:'anchor',minHeight:245,flex:1,items:[editors.email,editors.password,editors.firstname,editors.lastname,editors.Language,editors.ownersadmin,editors.playersmanager,editors.maxratinglevel,editors.state]}],buttons:[{text:_('Cancel'),handler:function(){if(record.phantom){record.store.deleteRecord(record);}
win.close();}},{text:_('Confirm'),formBind:true,handler:function(){if(form.isValid()){form.updateRecord(record);win.close();Ext.create("MP.window.Notification",{position:'t',width:260,title:_('Changes have been applied…'),html:_('Your changes have been applied <strong>locally</strong>.<br/><br/>To make them permanent you must click on the <blink>Save</blink> button.'),iconCls:'info-icon'}).show();}}}]});win=desktop.createWindow({id:'edit-user-win',title:_('Edit user'),iconCls:me.module.iconCls,width:size.width,height:size.height,modal:true,items:form,closable:false,minimizable:false,maximizable:false,resizable:false,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640),wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/users.html#insert-and-edit'),title:_('Help on user insert/edit')});wh.show();}}]});form.loadRecord(record);win.show();}});Ext.define('SoL.module.Users',{extend:'MP.desktop.Module',requires:['MP.grid.Panel'],uses:['SoL.module.Users.Actions','SoL.window.Help'],id:'users-win',iconCls:'users-icon',launcherText:function(){return _('Users');},launcherTooltip:function(){return _('<b>Users</b><br />Basic users management.');},config:{xtype:'editable-grid',pageSize:14,autoShowAllEditors:false,clicksToEdit:0,dataURL:'/data/users',saveChangesURL:'/bio/saveChanges',sorters:['lastname','firstname'],stripeRows:true,selModel:{mode:'MULTI'},newRecordData:{state:'C'}},getConfig:function(callback){var me=this,cfg=me.config;if(!cfg.metadata){MP.data.MetaData.fetch(cfg.dataURL,me,function(metadata){var overrides={},fields=metadata.fields(overrides);Ext.apply(cfg,{metadata:metadata,fields:fields,columns:metadata.columns(overrides,false),idProperty:metadata.primary_key,totalProperty:metadata.count_slot,successProperty:metadata.success_slot,rootProperty:metadata.root_slot,plugins:[Ext.create('SoL.module.Users.Actions',{module:me})]});callback(cfg);me.app.on('logout',function(){delete cfg.metadata;},me,{single:true});});}else{callback(cfg);}},createOrShowWindow:function(iduser){var me=this,config=me.config,desktop=me.app.getDesktop(),win=desktop.getWindow(me.id);if(win){win.destroy();}
me.configure([me.getConfig],function(done){var size=desktop.getReasonableWindowSize(780,421,"C");win=desktop.createWindow({id:me.id,title:me.windowTitle||me.getLauncherText(),taskbuttonTooltip:me.getLauncherTooltip(),iconCls:me.iconCls,items:[config],x:size.x,y:size.y,width:size.width,height:size.height,tools:[{type:'help',tooltip:_('Show user manual section.'),callback:function(){var whsize=desktop.getReasonableWindowSize(800,640);var wh=Ext.create('SoL.window.Help',{width:whsize.width,height:whsize.height,help_url:_('/static/manual/en/users.html'),title:_('Help on users management')});wh.show();}}]});var grid=win.child('editable-grid');grid.store.load({params:{start:0,limit:me.pageSize},callback:function(){win.on({show:done,single:true});win.show();}});var da=grid.findActionById('delete');da.shouldBeDisabled=me.shouldDisableDeleteAction.bind(grid);});},shouldDisableDeleteAction:function(){var grid=this,sm=grid.getSelectionModel(),currentuser=grid.up().up().app.user;if(sm.getCount()>0){var disable=!currentuser.is_admin;return disable;}else{return true;}}});