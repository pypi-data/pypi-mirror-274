web: DB_CHECK_SCHEMA=false python3 -m waitress --port $PORT --url-scheme=https --threads=${NB_API_THREADS:-4} --trusted-proxy '*' --trusted-proxy-headers 'X-Forwarded-For X-Forwarded-Host X-Forwarded-Port X-Forwarded-Proto' --log-untrusted-proxy-headers --clear-untrusted-proxy-headers --call 'geovisio:create_app'

# After having poped the API, we upgrade the database schema
# If the postdeploy fails, scalingo will not expose the new app, and will keep the old one
# Note that we added DB_CHECK_SCHEMA=false on the `web` to ensure that it starts without checking the schema (since it will be updated after)
# Note2: scalingo has a 20mn timeout for this, so migration longer will need to be applied manually
postdeploy: flask db upgrade
